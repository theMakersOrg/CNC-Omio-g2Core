
<!-- saved from url=(0129)http://webcache.googleusercontent.com/search?q=cache:ObObfM1da8gJ:nv50.0fees.net/Doc/Mach3Mysteries.pdf+&cd=1&hl=en&ct=clnk&gl=au -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style>body{margin-left:0;margin-right:0;margin-top:0}#bN015htcoyT__google-cache-hdr{background:#f5f5f5;font:13px arial,sans-serif;text-align:left;color:#202020;border:0;margin:0;border-bottom:1px solid #cecece;line-height:16px;padding:16px 28px 24px 28px}#bN015htcoyT__google-cache-hdr *{display:inline;font:inherit;text-align:inherit;color:inherit;line-height:inherit;background:none;border:0;margin:0;padding:0;letter-spacing:0}#bN015htcoyT__google-cache-hdr a{text-decoration:none;color:#1a0dab}#bN015htcoyT__google-cache-hdr a:hover{text-decoration:underline}#bN015htcoyT__google-cache-hdr a:visited{color:#609}#bN015htcoyT__google-cache-hdr div{display:block;margin-top:4px}#bN015htcoyT__google-cache-hdr b{font-weight:bold;display:inline-block;direction:ltr}</style></head><body bgcolor="#ffffff" vlink="blue" link="blue"><div id="bN015htcoyT__google-cache-hdr"><div><span>This is the HTML version of the file <a href="http://nv50.0fees.net/Doc/Mach3Mysteries.pdf">http://nv50.0fees.net/Doc/Mach3Mysteries.pdf</a>. Google automatically generates HTML versions of documents as we crawl the web.</span></div><span style="display:inline-block;margin-top:8px;color:#717171"><span>Tip: To quickly find your search term on this page, press <b>Ctrl+F</b> or <b>⌘-F</b> (Mac) and use the find bar.</span></span></div><div style="position:relative;">


<meta name="Producer" content="AFPL Ghostscript 8.53">
<meta name="CreationDate" content="D:20080128101251">
<meta name="ModDate" content="D:20100606181306+01&#39;00&#39;">
<meta name="Title" content="Microsoft Word - Mach3Mysteries.Doc">
<meta name="Creator" content="PScript5.dll Version 5.2.2">
<meta name="Author" content="Art">
<title>Mach3 Internals A Plug-In Writers Bible. by Art Fenerty </title>

<table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="1"><b>Page 1</b></a></font></td></tr></tbody></table><font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:469;left:413"><nobr>Mach3 Internals</nobr></div>
<div style="position:absolute;top:502;left:392"><nobr>A Plug-In Writers Bible.</nobr></div>
<div style="position:absolute;top:534;left:452"><nobr>by</nobr></div>
<div style="position:absolute;top:571;left:427"><nobr>Art Fenerty </nobr></div>
</span></font>

<div style="position:absolute;top:1363;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="2"><b>Page 2</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:1417;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:1416;left:742"><nobr>1</nobr></div>
<div style="position:absolute;top:1493;left:166"><nobr><b>What do I know</b>?</nobr></div>
<div style="position:absolute;top:1552;left:183"><nobr>I get accused allot of knowing CNC well, or of being some sort of CNC Guru. Let</nobr></div>
<div style="position:absolute;top:1571;left:166"><nobr>me assure you nothing could be further from the truth. I once read an article from an</nobr></div>
<div style="position:absolute;top:1591;left:166"><nobr>education researcher that it takes 10 years to become a Master of any subject. That is</nobr></div>
<div style="position:absolute;top:1610;left:166"><nobr>to say that with hard work and study anyone can master any subject they pick in 10</nobr></div>
<div style="position:absolute;top:1630;left:166"><nobr>years. Likely, that is a bit light for some fields, but I get the feeling it is accurate for</nobr></div>
<div style="position:absolute;top:1649;left:166"><nobr>most. This includes CNC. That has not to say everyone in CNC for 10 years is a</nobr></div>
<div style="position:absolute;top:1669;left:166"><nobr>master. Some people have one year of experience and they repeat it 10 times. This</nobr></div>
<div style="position:absolute;top:1688;left:166"><nobr>would not be mastering the topic. </nobr></div>
<div style="position:absolute;top:1708;left:179"><nobr>My introduction to CNC was 6 years ago. Up to then I could not have told you what</nobr></div>
<div style="position:absolute;top:1727;left:166"><nobr>the letters CNC stood for. (Constantly Nagging Complexities)? Since then, I have</nobr></div>
<div style="position:absolute;top:1747;left:166"><nobr>worked hard and studied allot, but most of my knowledge is theoretical, gleaned from</nobr></div>
<div style="position:absolute;top:1766;left:166"><nobr>thousands of posts and emails on various suggestions for added functionality and</nobr></div>
<div style="position:absolute;top:1786;left:166"><nobr>reports of problems that people have encountered. This does not make me an expert</nobr></div>
<div style="position:absolute;top:1805;left:166"><nobr>by a long shot. I am constantly surprised by code I see, and by the ways that people</nobr></div>
<div style="position:absolute;top:1825;left:166"><nobr>use the various machines hooked up to Mach3. True mastery of CNC takes a very</nobr></div>
<div style="position:absolute;top:1844;left:166"><nobr>long time and a heck of a lot of perseverance. I haven’t got there as yet, but when it</nobr></div>
<div style="position:absolute;top:1864;left:166"><nobr>comes to exactly how Mach3 does its job, I know it pretty well and Ill try to help you</nobr></div>
<div style="position:absolute;top:1883;left:166"><nobr>understand it to the depth you may ( or may not) want to. This document is not a</nobr></div>
<div style="position:absolute;top:1902;left:166"><nobr>manual, it is not going to be indexed or have links to various subjects. It's more of a</nobr></div>
<div style="position:absolute;top:1922;left:166"><nobr>discussion of Mach3 and how it works. A plug-in programmer will want to read and</nobr></div>
<div style="position:absolute;top:1942;left:166"><nobr>re-read several sections of it. A user may want to read it if he's bored, or wants to</nobr></div>
<div style="position:absolute;top:1961;left:166"><nobr>understand the reasons behind why he is forced to do some things in strange ways. In</nobr></div>
<div style="position:absolute;top:1980;left:166"><nobr>my experience, the more one understands the way a program works, the better they</nobr></div>
<div style="position:absolute;top:2000;left:166"><nobr>can use it. Mach3 is not a typical program. Its event driven for the most part, timer</nobr></div>
<div style="position:absolute;top:2019;left:166"><nobr>driven in several other parts and overall is a compromise between what is possible and</nobr></div>
<div style="position:absolute;top:2039;left:166"><nobr>what is not in Windows based CNC. Several have asked why I never ported to Linux,</nobr></div>
<div style="position:absolute;top:2058;left:166"><nobr>the reason is simple. EMC is an excellent program, is in Linux, and those who use</nobr></div>
<div style="position:absolute;top:2078;left:166"><nobr>that flavor of operating system already have a solution. I dislike programming in</nobr></div>
<div style="position:absolute;top:2097;left:166"><nobr>Unix, am aware that over 90% of the world uses Windows, and my internal drive to</nobr></div>
<div style="position:absolute;top:2117;left:166"><nobr>do Mach3 was based more on providing a solution than selling software. It was a case</nobr></div>
<div style="position:absolute;top:2136;left:166"><nobr>of "If you build it, they will come.". Turned out that way anyhow, and as of my</nobr></div>
<div style="position:absolute;top:2156;left:166"><nobr>retiring from Mach3 development, over 12000 users had come. They all came with</nobr></div>
<div style="position:absolute;top:2175;left:166"><nobr>various levels of understanding, and various backgrounds in CNC that defined their</nobr></div>
<div style="position:absolute;top:2195;left:166"><nobr>expectations. For my part I tried to do what was possible, and the result is a program</nobr></div>
<div style="position:absolute;top:2214;left:166"><nobr>that will do most jobs within certain limitations. If you actually make it through this</nobr></div>
<div style="position:absolute;top:2234;left:166"><nobr>document you'll know the limitations and why they exist. If you are a plug-in</nobr></div>
<div style="position:absolute;top:2253;left:166"><nobr>programmer you'll be able to better understand the flow of the program and how to</nobr></div>
<div style="position:absolute;top:2273;left:166"><nobr>interface to its internals. </nobr></div>
<div style="position:absolute;top:2312;left:166"><nobr><b>Its all Connected</b>:</nobr></div>
<div style="position:absolute;top:2351;left:174"><nobr>To fully understand what Mach3 will do in a given situation, you really have to have</nobr></div>
<div style="position:absolute;top:2370;left:166"><nobr>a general understanding of how a system all fits together. The better one understands</nobr></div>
<div style="position:absolute;top:2389;left:166"><nobr>all aspects of the cnc system, the better the end results of their work. This document is </nobr></div>
</span></font>

<div style="position:absolute;top:2551;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="3"><b>Page 3</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:2605;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:2604;left:742"><nobr>2</nobr></div>
<div style="position:absolute;top:2682;left:166"><nobr>meant to explain a bit about the interactions within Mach3 of the various subsystems,</nobr></div>
<div style="position:absolute;top:2701;left:166"><nobr>including GCode, ModBus, General inputs, Brains, and whatever else one tends to</nobr></div>
<div style="position:absolute;top:2721;left:166"><nobr>connect to the software. Its my hope, that after reading this , the user will have a better</nobr></div>
<div style="position:absolute;top:2740;left:166"><nobr>overall understanding of the complexities involved, and what to consider when trying</nobr></div>
<div style="position:absolute;top:2759;left:166"><nobr>to setup a machine for a particular purpose. As I stated, don't expect cross references</nobr></div>
<div style="position:absolute;top:2779;left:166"><nobr>and details as to where to find information on various subjects. This is a discussion on</nobr></div>
<div style="position:absolute;top:2798;left:166"><nobr>mach3 in which you have to pretend your in a room with me and I'm rambling on.</nobr></div>
<div style="position:absolute;top:2818;left:166"><nobr>Close your eyes and you will be able to picture you are here with me and I simply</nobr></div>
<div style="position:absolute;top:2837;left:166"><nobr>refuse to let you get a word in edgewise. Well, OK if you close your eyes Ill go quiet</nobr></div>
<div style="position:absolute;top:2857;left:166"><nobr>as you wont be able to read, but here again you don’t get to tell me that so Ill</nobr></div>
<div style="position:absolute;top:2876;left:166"><nobr>continue.. </nobr></div>
<div style="position:absolute;top:2916;left:166"><nobr><b>EVOLUTION</b></nobr></div>
<div style="position:absolute;top:2954;left:166"><nobr>Mach3 is a product of evolution. Originally designed only for my own use on a router</nobr></div>
<div style="position:absolute;top:2974;left:166"><nobr>table, it has evolved over time at the request of thousands of people to be all things to</nobr></div>
<div style="position:absolute;top:2993;left:166"><nobr>all men in terms of cnc operation. That process is likely far from complete and</nobr></div>
<div style="position:absolute;top:3013;left:166"><nobr>continues with more and more requests each month as to what needs to be added. At</nobr></div>
<div style="position:absolute;top:3032;left:166"><nobr>the time of Master5's creation (Master5 being Mach3's distant ancestor) it was</nobr></div>
<div style="position:absolute;top:3052;left:166"><nobr>expensive to do CNC. The costs seemed to me at the time to be much higher then</nobr></div>
<div style="position:absolute;top:3071;left:166"><nobr>necessary, certainly more than I was willing to pay, so Master5 was written to run my</nobr></div>
<div style="position:absolute;top:3090;left:166"><nobr>table. Actually, the program was called EZCNC in those days, but was quickly</nobr></div>
<div style="position:absolute;top:3110;left:166"><nobr>renamed to Master5. (After going through Master1, 2, 3, and 4 behind the scenes).</nobr></div>
<div style="position:absolute;top:3130;left:166"><nobr>Master5 brought a modicum of motor control to Windows 95 in the form of a</nobr></div>
<div style="position:absolute;top:3149;left:166"><nobr>reprogrammed motherboard timer which could be bumped to 8Khz to allow for a</nobr></div>
<div style="position:absolute;top:3168;left:166"><nobr>steady stream of step pulses without worrying too much about Windows interrupting</nobr></div>
<div style="position:absolute;top:3188;left:166"><nobr>the stream. One of the many reasons CNC was so expensive back then for a Windows</nobr></div>
<div style="position:absolute;top:3207;left:166"><nobr>user was that Windows is not capable of pulse generation in a timely or smooth</nobr></div>
<div style="position:absolute;top:3227;left:166"><nobr>manner. Master5 reprogrammed the system timer and ran in Ring0 at interrupt 8 to</nobr></div>
<div style="position:absolute;top:3246;left:166"><nobr>get a stable stream. This allowed motor control to be done efficiently up to a</nobr></div>
<div style="position:absolute;top:3266;left:166"><nobr>maximum speed of 8Khz. (Back then that was considered fast enough for the majority</nobr></div>
<div style="position:absolute;top:3285;left:166"><nobr>of homebuilders. Things have changed now! ).</nobr></div>
<div style="position:absolute;top:3305;left:166"><nobr>As we progressed from Win95 to Windows XP, a new generation of timer was</nobr></div>
<div style="position:absolute;top:3324;left:166"><nobr>required. It took months to develop the theory and to force Windows to do something</nobr></div>
<div style="position:absolute;top:3344;left:166"><nobr>it truly despises, to give reliable step pulses at high speeds. At time of writing this, the</nobr></div>
<div style="position:absolute;top:3363;left:166"><nobr>maximum is 100K per second, but really, in general operation, 65000 or so per second</nobr></div>
<div style="position:absolute;top:3383;left:166"><nobr>is the limit for most CPU's. There exist several reasons for this. To understand the</nobr></div>
<div style="position:absolute;top:3402;left:166"><nobr>timer is to understand why Mach3 operates as it does in many areas of its use. All</nobr></div>
<div style="position:absolute;top:3422;left:166"><nobr>processes have built in limitations, and Mach3 has several by virtue of its design. It</nobr></div>
<div style="position:absolute;top:3441;left:166"><nobr>has to be remembered that what Mach3 does was considered for a long time to be</nobr></div>
<div style="position:absolute;top:3461;left:166"><nobr>impossible, and it relies on some devious trickery to do its job and an intricate game</nobr></div>
<div style="position:absolute;top:3480;left:166"><nobr>that Mach plays with the Operating System is what creates some of the limitations.</nobr></div>
<div style="position:absolute;top:3500;left:166"><nobr>Some will wonder why it is then, when an external device is used ( smoothstepper,</nobr></div>
<div style="position:absolute;top:3519;left:166"><nobr>Galil, G100, ncPod..etc..) those limitations still exist. This seems nonsensical on its</nobr></div>
<div style="position:absolute;top:3539;left:166"><nobr>face, but when you consider Mach3 was designed for the printer port, and its</nobr></div>
<div style="position:absolute;top:3558;left:166"><nobr>architecture is derived from the treacherous territory of Windows kernel mode, then it</nobr></div>
<div style="position:absolute;top:3577;left:166"><nobr>will be understood more easily, why the design architecture, which has evolved over </nobr></div>
</span></font>

<div style="position:absolute;top:3739;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="4"><b>Page 4</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:3793;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:3792;left:742"><nobr>3</nobr></div>
<div style="position:absolute;top:3870;left:166"><nobr>time, must reflect the original printer port operation in terms of its internal limitations.</nobr></div>
<div style="position:absolute;top:3889;left:166"><nobr>This means that the simple fact you are using an external engine does not mean you</nobr></div>
<div style="position:absolute;top:3909;left:166"><nobr>will not necessarily have a limitation enforced by the original specifications of the</nobr></div>
<div style="position:absolute;top:3928;left:166"><nobr>software. Of course, work is always ongoing to separate main core components to</nobr></div>
<div style="position:absolute;top:3947;left:166"><nobr>provide a level of isolation that provides for removing external limitations on pulse</nobr></div>
<div style="position:absolute;top:3967;left:166"><nobr>output.</nobr></div>
<div style="position:absolute;top:4006;left:166"><nobr><b>The Timer</b></nobr></div>
<div style="position:absolute;top:4045;left:166"><nobr>The timer in Mach3 is special. Its only real purpose in life is to deal with things</nobr></div>
<div style="position:absolute;top:4064;left:166"><nobr>required to be done more quickly that Windows OS's will typically allow.</nobr></div>
<div style="position:absolute;top:4084;left:166"><nobr>For those that wonder how that is done, it is a several step process. The timer, when</nobr></div>
<div style="position:absolute;top:4103;left:166"><nobr>you startup mach3, analyses a bit about your motherboard to see how it is using</nobr></div>
<div style="position:absolute;top:4123;left:166"><nobr>various timing systems. It then reprograms the motherboard to take advantage of the</nobr></div>
<div style="position:absolute;top:4142;left:166"><nobr>apic local timer unused in almost all CPU chips. If no apic chip is present, or if it is</nobr></div>
<div style="position:absolute;top:4162;left:166"><nobr>used then Mach3 will institute a different method of getting the CPU, interrupt set to</nobr></div>
<div style="position:absolute;top:4181;left:166"><nobr>the main timer chip used. It redirects the interrupts on your system to take over</nobr></div>
<div style="position:absolute;top:4201;left:166"><nobr>interrupt 0, the highest interrupt level you can have in a software environment. It does</nobr></div>
<div style="position:absolute;top:4220;left:166"><nobr>not allow any other software system to interrupt it, and it can stop windows to do its</nobr></div>
<div style="position:absolute;top:4240;left:166"><nobr>job without windows knowing its there. It shares a block of memory with Mach3 and</nobr></div>
<div style="position:absolute;top:4259;left:166"><nobr>operates totally as an independent agent of pulsing. It follows commands sent to it via</nobr></div>
<div style="position:absolute;top:4278;left:166"><nobr>the shared memory block, and processes data in the block to be sent out, as well as</nobr></div>
<div style="position:absolute;top:4298;left:166"><nobr>takes incoming data from the ports and puts it into the memory block so that Mach3's</nobr></div>
<div style="position:absolute;top:4318;left:166"><nobr>main application can see it. Mach3's application actually has no knowledge of the</nobr></div>
<div style="position:absolute;top:4337;left:166"><nobr>hardware involved. It simply has to set memory variables</nobr></div>
<div style="position:absolute;top:4356;left:166"><nobr>in the shared block and the engine, merrily running on its own in Ring 0 ( privileged</nobr></div>
<div style="position:absolute;top:4376;left:166"><nobr>windows space) at a very high rate of speed, will then deal with those variables ,</nobr></div>
<div style="position:absolute;top:4395;left:166"><nobr>sending pulses, setting output bits, or performing whatever automatic functions it may</nobr></div>
<div style="position:absolute;top:4415;left:166"><nobr>be programmed to do. </nobr></div>
<div style="position:absolute;top:4434;left:166"><nobr>The Driver does have some automatic functions, things that it must do on its own, as</nobr></div>
<div style="position:absolute;top:4454;left:166"><nobr>the Windows system cannot respond fast enough to help with the job. Jogging is a</nobr></div>
<div style="position:absolute;top:4473;left:166"><nobr>good example. There is no way windows can handle the complexities of jogging, so</nobr></div>
<div style="position:absolute;top:4493;left:166"><nobr>the driver must handle it by command from the application. Homing is another. To</nobr></div>
<div style="position:absolute;top:4512;left:166"><nobr>keep accurate, Windows is not fast enough to stop at the proper position when reading</nobr></div>
<div style="position:absolute;top:4532;left:166"><nobr>a switch, so the driver must intervene. </nobr></div>
<div style="position:absolute;top:4551;left:166"><nobr>For technical reasons, the engine cannot do any floating point. This is because it is a</nobr></div>
<div style="position:absolute;top:4571;left:166"><nobr>very time critical subsystem. You can imagine what would happen if in the course of</nobr></div>
<div style="position:absolute;top:4590;left:166"><nobr>events, while Windows is calculating the balance of your checking account and is</nobr></div>
<div style="position:absolute;top:4610;left:166"><nobr>about to divide two numbers, Mach3's engine stopped it, used the floating point chip,</nobr></div>
<div style="position:absolute;top:4629;left:166"><nobr>and then returned to Windows. This interaction could cause the wrong result. It is</nobr></div>
<div style="position:absolute;top:4649;left:166"><nobr>possible to store the floating-point state of your computer, then do the work in the</nobr></div>
<div style="position:absolute;top:4668;left:166"><nobr>engine, then restore the various stacks, but the time required would make things</nobr></div>
<div style="position:absolute;top:4688;left:166"><nobr>difficult on slower computers. For that reason, no floating point is allowed.  </nobr></div>
<div style="position:absolute;top:4727;left:166"><nobr>So all that having been said, lets look at some example functions of the system to see</nobr></div>
<div style="position:absolute;top:4746;left:166"><nobr>how they are done. This is the best way I think to see the flow and begin to</nobr></div>
<div style="position:absolute;top:4765;left:166"><nobr>understand how Mach3 looks at the world as an overall synchronized system. </nobr></div>
</span></font>

<div style="position:absolute;top:4927;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="5"><b>Page 5</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:4981;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:4980;left:742"><nobr>4</nobr></div>
<div style="position:absolute;top:5077;left:166"><nobr><b>Jog Motion</b>:</nobr></div>
<div style="position:absolute;top:5116;left:174"><nobr>Jogging is done using pure integer math. It is automatic in the engine when the</nobr></div>
<div style="position:absolute;top:5135;left:166"><nobr>application sets certain variables in the memory block. (In future, let us just refer to</nobr></div>
<div style="position:absolute;top:5155;left:166"><nobr>the shared memory block between mach3 and its engine as the Block, the driver as the</nobr></div>
<div style="position:absolute;top:5174;left:166"><nobr>Engine, and the Mach3 as the App. It will hopefully make things clearer. )</nobr></div>
<div style="position:absolute;top:5194;left:166"><nobr>Every interrupt, the driver checks to see if it should be jogging. The engine is a point</nobr></div>
<div style="position:absolute;top:5213;left:166"><nobr>checker. It checks several different ways to see if it should take a step. If it is not</nobr></div>
<div style="position:absolute;top:5233;left:166"><nobr>running a program then on every interrupt, it will check to see if it is jogging. When I</nobr></div>
<div style="position:absolute;top:5252;left:166"><nobr>say interrupt, I mean every check at the speed of your kernel mode. If you have 25000</nobr></div>
<div style="position:absolute;top:5272;left:166"><nobr>selected, and Ill assume you do through the rest of these discussions, then that is every</nobr></div>
<div style="position:absolute;top:5291;left:166"><nobr>1/25000 or 40us of time.  Therefore, every 40us the engine looks at six sets of</nobr></div>
<div style="position:absolute;top:5311;left:166"><nobr>variables, one for each axis. In the variable Engine-&gt;Axis[n].Jogging the system sees</nobr></div>
<div style="position:absolute;top:5330;left:166"><nobr>if indeed the axis should be considered in the jog processor. If it is set to true the</nobr></div>
<div style="position:absolute;top:5350;left:166"><nobr>driver looks to additional variable to see what speed we are doing, and what</nobr></div>
<div style="position:absolute;top:5369;left:166"><nobr>acceleration should be used to increase the speed, or finally to see if we are</nobr></div>
<div style="position:absolute;top:5389;left:166"><nobr>decelerating and if so, if we should stop. All of these variables are in the engine as a</nobr></div>
<div style="position:absolute;top:5408;left:166"><nobr>set of structures called the Axis structures. </nobr></div>
<div style="position:absolute;top:5428;left:166"><nobr>struct AxisInfo</nobr></div>
<div style="position:absolute;top:5447;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:5466;left:183"><nobr>int   Index;    // Current Count</nobr></div>
<div style="position:absolute;top:5486;left:227"><nobr>int   MasterIndex; //Unused at this point</nobr></div>
<div style="position:absolute;top:5506;left:227"><nobr>char  StepPin;     // Pin for step pulse</nobr></div>
<div style="position:absolute;top:5525;left:227"><nobr>char  DirPin;     // Pin for Direction Pulse</nobr></div>
<div style="position:absolute;top:5544;left:227"><nobr>char  StepPort;    // Port # for step</nobr></div>
<div style="position:absolute;top:5564;left:227"><nobr>char  DirPort;     // Port # for Direction</nobr></div>
<div style="position:absolute;top:5583;left:227"><nobr>bool  StepNegate;   // low active step?</nobr></div>
<div style="position:absolute;top:5603;left:227"><nobr>bool  DirNegate;    // low active Direction?</nobr></div>
<div style="position:absolute;top:5622;left:227"><nobr>int   CurVelocity;  // Current Velocity</nobr></div>
<div style="position:absolute;top:5642;left:227"><nobr>int   MaxVelocity;  // Current Max Velocity (jogging )</nobr></div>
<div style="position:absolute;top:5661;left:227"><nobr>int   MasterVelocity; // Master Velocity...Maximum Velocity in all</nobr></div>
<div style="position:absolute;top:5681;left:166"><nobr>circumstances.</nobr></div>
<div style="position:absolute;top:5700;left:227"><nobr>int   Acceleration; // Acceleration</nobr></div>
<div style="position:absolute;top:5720;left:227"><nobr>bool  AtSpeed;     // At Speed Currently</nobr></div>
<div style="position:absolute;top:5739;left:227"><nobr>bool  Acc;     // Accelerating?</nobr></div>
<div style="position:absolute;top:5759;left:227"><nobr>bool  Dec;     // Decelerating?</nobr></div>
<div style="position:absolute;top:5778;left:227"><nobr>bool  Enable;     // Axis Enabled?</nobr></div>
<div style="position:absolute;top:5798;left:227"><nobr>bool  Jogging;     // Jogging On?</nobr></div>
<div style="position:absolute;top:5817;left:227"><nobr>int   JoggDir;     // Direction of Jog;</nobr></div>
<div style="position:absolute;top:5837;left:227"><nobr>bool  Homing;     // is this a homing jog?</nobr></div>
<div style="position:absolute;top:5856;left:227"><nobr>bool  DeRef;     // Dereferanceing Move?</nobr></div>
<div style="position:absolute;top:5876;left:227"><nobr>int   Memory[6];</nobr></div>
<div style="position:absolute;top:5895;left:227"><nobr>int   ActiveMemory;</nobr></div>
<div style="position:absolute;top:5915;left:227"><nobr>int   Color;</nobr></div>
<div style="position:absolute;top:5934;left:227"><nobr>int   TripCount;    // when to stop a probe</nobr></div>
<div style="position:absolute;top:5953;left:227"><nobr>int   DepthCount;   //where a probe actually hit </nobr></div>
</span></font>

<div style="position:absolute;top:6115;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="6"><b>Page 6</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:6169;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:6168;left:742"><nobr>5</nobr></div>
<div style="position:absolute;top:6246;left:227"><nobr>bool  Probing;     // if we're probing or not.</nobr></div>
<div style="position:absolute;top:6265;left:227"><nobr>bool  Slave;     // if this axis is a slave or not.</nobr></div>
<div style="position:absolute;top:6285;left:227"><nobr>int   SlaveAxis;    // if so, who the heck are we slaved to?</nobr></div>
<div style="position:absolute;top:6323;left:166"><nobr>};</nobr></div>
<div style="position:absolute;top:6343;left:166"><nobr>There are actually 7 axis structures, 6 motion axis and one spindle. However, the</nobr></div>
<div style="position:absolute;top:6362;left:166"><nobr>spindle is special and not processed the same way. Things like Jog variables and such</nobr></div>
<div style="position:absolute;top:6382;left:166"><nobr>are ignored in the spindle processing.</nobr></div>
<div style="position:absolute;top:6421;left:166"><nobr>Say the user has hit the Jog Key. To Jog ,the App gets information you’ve told it in</nobr></div>
<div style="position:absolute;top:6440;left:166"><nobr>motor tuning, and calculates a maximum jog speed, puts it in MaxVelocity in the Axis</nobr></div>
<div style="position:absolute;top:6460;left:166"><nobr>structure for that axis, it sets the acceleration in Acc, sets false in the Dec variable to</nobr></div>
<div style="position:absolute;top:6479;left:166"><nobr>indicate we are not currently decelerating, and finally sets Jogging to true. The App</nobr></div>
<div style="position:absolute;top:6499;left:166"><nobr>must also set the Dir variable to indicate what direction we wish to jog. From there it</nobr></div>
<div style="position:absolute;top:6518;left:166"><nobr>is all auto magic. The driver will see the current velocity is zero; it will take the</nobr></div>
<div style="position:absolute;top:6538;left:166"><nobr>acceleration and add it to the current velocity. It will then use the current velocity to</nobr></div>
<div style="position:absolute;top:6557;left:166"><nobr>keep a stream of step pulses coming out at that speed. Remember that this happens</nobr></div>
<div style="position:absolute;top:6577;left:166"><nobr>25000 times a second, so the acceleration of the steps coming out will have a very</nobr></div>
<div style="position:absolute;top:6596;left:166"><nobr>tight granularity of change. This makes it very smooth and accurate in terms of its</nobr></div>
<div style="position:absolute;top:6616;left:166"><nobr>ramping. The Acc value and the MaxVelocity values are calculated numbers. They</nobr></div>
<div style="position:absolute;top:6635;left:166"><nobr>are not in steps/second or anything that simplistic. In reality, they are the number of</nobr></div>
<div style="position:absolute;top:6654;left:166"><nobr>steps per second divided by the kernel frequency and multiplied by 2048. The engine</nobr></div>
<div style="position:absolute;top:6674;left:166"><nobr>uses these numbers as mentioned to automatically calculate on each interrupt the</nobr></div>
<div style="position:absolute;top:6694;left:166"><nobr>current speed. It then uses that speed to sense if a pulse should be put out or not</nobr></div>
<div style="position:absolute;top:6713;left:166"><nobr>during that interrupt. If the current speed is equal to the kernel speed multiplied by</nobr></div>
<div style="position:absolute;top:6732;left:166"><nobr>2048 than a pulse will be put out on each interrupt, so maximum system speed is sent</nobr></div>
<div style="position:absolute;top:6752;left:166"><nobr>to the motor. The MaxVelocity setting keeps the speed limited to the maximum set in</nobr></div>
<div style="position:absolute;top:6771;left:166"><nobr>the motor tuning, scaled by the Jog% setting in the App and applied to the formulas</nobr></div>
<div style="position:absolute;top:6791;left:166"><nobr>explained above. To stop a jogging on any axis, the App needs only to set the Dec</nobr></div>
<div style="position:absolute;top:6810;left:166"><nobr>(decelerate) variable to true. The engine will automatically decelerate the axis</nobr></div>
<div style="position:absolute;top:6830;left:166"><nobr>interrupt by interrupt until it hits zero and which time the driver will set the Jogging</nobr></div>
<div style="position:absolute;top:6849;left:166"><nobr>variable in the axis structure to false on its own. The application now knows through</nobr></div>
<div style="position:absolute;top:6869;left:166"><nobr>simply checking the Jogging variable if an axis is jogging, what direction, and what</nobr></div>
<div style="position:absolute;top:6888;left:166"><nobr>speed at any time, even though its not actually doing the work.  This is why Mach3 is</nobr></div>
<div style="position:absolute;top:6908;left:166"><nobr>possible. It usually is not doing much of the work, the Engine is the workhorse and it</nobr></div>
<div style="position:absolute;top:6927;left:166"><nobr>runs very fast. </nobr></div>
<div style="position:absolute;top:6947;left:166"><nobr>There are variations on the Jogging process. Probing for example is just a jog.</nobr></div>
<div style="position:absolute;top:6966;left:166"><nobr>TripCount is simply set to the step count when the engine will set the Dec variable to</nobr></div>
<div style="position:absolute;top:6986;left:166"><nobr>true on its own, probing is set to true, and the rest of the jogging parameters are set as</nobr></div>
<div style="position:absolute;top:7005;left:166"><nobr>above. The engine will then automatically stop the jog when the probe input goes</nobr></div>
<div style="position:absolute;top:7025;left:166"><nobr>active or when the axis Index value hits the setting in TripCount. Index is a very</nobr></div>
<div style="position:absolute;top:7044;left:166"><nobr>important variable. It is the count of steps taken. It is incremented or decremented</nobr></div>
<div style="position:absolute;top:7064;left:166"><nobr>each time the engine puts out a step. This way Mach3 always knows where it is at and</nobr></div>
<div style="position:absolute;top:7083;left:166"><nobr>very accurately. Nothing sets the index except steps going out, or a homing operation</nobr></div>
<div style="position:absolute;top:7103;left:166"><nobr>that zeros the Index. Otherwise, it remains untouched by any code to ensure accuracy.</nobr></div>
<div style="position:absolute;top:7122;left:166"><nobr>If the DRO does not agree with motor position, the motor lost steps. There can be no</nobr></div>
<div style="position:absolute;top:7141;left:166"><nobr>question about that, and it was planned that way as a main system diagnostic value. </nobr></div>
</span></font>

<div style="position:absolute;top:7303;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="7"><b>Page 7</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:7357;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:7356;left:742"><nobr>6</nobr></div>
<div style="position:absolute;top:7434;left:166"><nobr>For Homing, the App simply sets the Homing variable in the axis structure to true,</nobr></div>
<div style="position:absolute;top:7453;left:166"><nobr>and then starts a jog in the direction set by the user in the homing config. The engine</nobr></div>
<div style="position:absolute;top:7473;left:166"><nobr>knows to stop when the axis hits a switch, move off, and then zero the Index register</nobr></div>
<div style="position:absolute;top:7492;left:166"><nobr>all on its own. The App is not involved other than to wait for all this to occur. In fact,</nobr></div>
<div style="position:absolute;top:7511;left:166"><nobr>most of the time the applications main job is to wait for something to be done or to</nobr></div>
<div style="position:absolute;top:7531;left:166"><nobr>occur. It is usually waiting on something because it looks at the world in a larger</nobr></div>
<div style="position:absolute;top:7550;left:166"><nobr>period as opposed to the engine view, which is very short. </nobr></div>
<div style="position:absolute;top:7570;left:166"><nobr>When the engine finishes an operation that has changed the position of a machine, and</nobr></div>
<div style="position:absolute;top:7589;left:166"><nobr>it knows it has no further commands to change the world's position, it signals the App</nobr></div>
<div style="position:absolute;top:7609;left:166"><nobr>of that by setting a Block variable called Sync. If the engine sets Engine-&gt;Sync to</nobr></div>
<div style="position:absolute;top:7628;left:166"><nobr>true, the App will then synchronize its internal knowledge of the world to the current</nobr></div>
<div style="position:absolute;top:7648;left:166"><nobr>settings of the Index registers in the axis structures. This means if you initiated a jog</nobr></div>
<div style="position:absolute;top:7667;left:166"><nobr>and stopped at an X of 10.5 inches, the driver on seeing the jog has stopped will issue</nobr></div>
<div style="position:absolute;top:7687;left:166"><nobr>a Sync command, which the App will then use to trigger an update of its trajectory</nobr></div>
<div style="position:absolute;top:7706;left:166"><nobr>planner to the X position of 10.5 so we remain in sync with the engine.  Any process</nobr></div>
<div style="position:absolute;top:7726;left:166"><nobr>can issue a Sync command by setting Engine-&gt;Sync = true. The variable will be reset</nobr></div>
<div style="position:absolute;top:7745;left:166"><nobr>to false when the App resyncs itself, usually within a 1/10 second time. </nobr></div>
<div style="position:absolute;top:7784;left:166"><nobr><b>Planned Motion</b>:</nobr></div>
<div style="position:absolute;top:7823;left:166"><nobr>The only other type of motion is a planned motion. This works quite differently from</nobr></div>
<div style="position:absolute;top:7842;left:166"><nobr>Jogging and is a source of the main limitations within Mach3, but also the reason</nobr></div>
<div style="position:absolute;top:7862;left:166"><nobr>Mach3 can work in Windows. It is the primary reasoning behind the rather strange</nobr></div>
<div style="position:absolute;top:7882;left:166"><nobr>architecture of the programs internals.  </nobr></div>
<div style="position:absolute;top:7901;left:166"><nobr>To initiate planned motion within the context of the Engine requires that the engine be</nobr></div>
<div style="position:absolute;top:7920;left:166"><nobr>told that motion is available. The Engine, as explained earlier is not capable of</nobr></div>
<div style="position:absolute;top:7940;left:166"><nobr>floating point operations, and in any event runs much too quickly to plan any</nobr></div>
<div style="position:absolute;top:7959;left:166"><nobr>upcoming motion. Planning motion is a complex task and uses much of the CPU time</nobr></div>
<div style="position:absolute;top:7979;left:166"><nobr>available. First, let us consider planned motion for the point of view of the Engine,</nobr></div>
<div style="position:absolute;top:7998;left:166"><nobr>which is only concerned with output of the step pulses required. The Engine uses a</nobr></div>
<div style="position:absolute;top:8018;left:166"><nobr>ring buffer of 4096 commands. Each of the commands in the ring comprises index</nobr></div>
<div style="position:absolute;top:8037;left:166"><nobr>locations, and some other information to help in smoothing the stream of steps. As</nobr></div>
<div style="position:absolute;top:8057;left:166"><nobr>you will recall, the main system for tracking a motor movement is the Index variable</nobr></div>
<div style="position:absolute;top:8076;left:166"><nobr>for each axis, it’s a count of actual steps put out. In the ring buffer, we divide time by</nobr></div>
<div style="position:absolute;top:8096;left:166"><nobr>kernel interrupt time multiplied by 5. For example, if the kernel speed is 25K, then the</nobr></div>
<div style="position:absolute;top:8115;left:166"><nobr>interrupt time is 40us, and multiplying by 5 gives us 200us. Therefore, the ring</nobr></div>
<div style="position:absolute;top:8135;left:166"><nobr>buffers entries actually represent 4096 time intervals of 200us. Therefore, the ring</nobr></div>
<div style="position:absolute;top:8154;left:166"><nobr>buffer contains entries signifying where the respective axis should be 200us from the</nobr></div>
<div style="position:absolute;top:8174;left:166"><nobr>last entry. This ensures that any entry in the ring buffer is no more than five steps</nobr></div>
<div style="position:absolute;top:8193;left:166"><nobr>from the previous entry and that the next entry will be no more than five steps from</nobr></div>
<div style="position:absolute;top:8213;left:166"><nobr>the current one. Some of you are scratching your heads here, so let us look deeper.</nobr></div>
<div style="position:absolute;top:8232;left:166"><nobr>First, a Ring Buffer is a loop, like a series of locations where the last location points</nobr></div>
<div style="position:absolute;top:8252;left:166"><nobr>back to the first one. SO let's consider a smaller ring of 10 locations, but remember</nobr></div>
<div style="position:absolute;top:8271;left:166"><nobr>that Mach3 uses 4096 positions in its ring buffer. </nobr></div>
<div style="position:absolute;top:8291;left:166"><nobr>Two pointers are used for all this, TrajHead and TrajIndex. For the programmers</nobr></div>
<div style="position:absolute;top:8310;left:166"><nobr>among you those variables are found in Engine-&gt;TrajHead and Engine-&gt;TrajIndex.</nobr></div>
<div style="position:absolute;top:8329;left:166"><nobr>Let's say they are both set to zero. The Engine, seeing they are equal will put out no </nobr></div>
</span></font>

<div style="position:absolute;top:8491;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="8"><b>Page 8</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:8545;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:8544;left:742"><nobr>7</nobr></div>
<div style="position:absolute;top:8622;left:166"><nobr>steps. It’s the App that fills the buffer. Each entry of the ring buffer comprises one</nobr></div>
<div style="position:absolute;top:8641;left:166"><nobr>copy of the following structure. </nobr></div>
<div style="position:absolute;top:8661;left:166"><nobr>struct TrajPoint</nobr></div>
<div style="position:absolute;top:8680;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:8699;left:174"><nobr>int Points[6];</nobr></div>
<div style="position:absolute;top:8719;left:174"><nobr>int Command;</nobr></div>
<div style="position:absolute;top:8738;left:174"><nobr>int ID;</nobr></div>
<div style="position:absolute;top:8758;left:174"><nobr>char shifter[6];</nobr></div>
<div style="position:absolute;top:8777;left:166"><nobr>};</nobr></div>
<div style="position:absolute;top:8816;left:166"><nobr>As you can see it's pretty small, but then that are 4096 of them used. The points[6]</nobr></div>
<div style="position:absolute;top:8836;left:166"><nobr>variable is related to the 6 axis and contains simply a count of the number of total</nobr></div>
<div style="position:absolute;top:8855;left:166"><nobr>steps in machine coordinates that the axis should be at when the buffer is sitting at</nobr></div>
<div style="position:absolute;top:8875;left:166"><nobr>that location. The Command variable is special , usually unused and tells the driver to</nobr></div>
<div style="position:absolute;top:8894;left:166"><nobr>trigger an event like special output types or special actions that can happen while it</nobr></div>
<div style="position:absolute;top:8914;left:166"><nobr>proceeds through the entries in the ring. As it hits that entry, it will perform that action</nobr></div>
<div style="position:absolute;top:8933;left:166"><nobr>prior to moving to the index locations in that entry. The ID is simply the GCode line</nobr></div>
<div style="position:absolute;top:8953;left:166"><nobr>number the entry is a part of. A simple move like G0X10 may contains tens of</nobr></div>
<div style="position:absolute;top:8972;left:166"><nobr>thousands of entries in the ring, so the ID changes only when the line number of the</nobr></div>
<div style="position:absolute;top:8992;left:166"><nobr>GCode from which the entry was derived changes. Shifter is a bit special, it tells the</nobr></div>
<div style="position:absolute;top:9011;left:166"><nobr>engine how to space the maximum of five steps the move represents to keep them as</nobr></div>
<div style="position:absolute;top:9030;left:166"><nobr>well anti-aliased as possible in time. Smoothness is the result. This "Shifter" variable</nobr></div>
<div style="position:absolute;top:9050;left:166"><nobr>is what you are turning off or on when you select "Enhanced Pulsing" in the App</nobr></div>
<div style="position:absolute;top:9070;left:166"><nobr>configurations. So let's consider our 10 position ring buffer, and make a move. When</nobr></div>
<div style="position:absolute;top:9089;left:166"><nobr>we start, both TrajHead and TrajIndex are zero; Mach 3 sets them that way on startup.</nobr></div>
<div style="position:absolute;top:9108;left:166"><nobr>Therefore, the driver looks only at Loc 0. </nobr></div>
<div style="position:absolute;top:9147;left:166"><nobr>Loc     0   1   2    3   4   5   6   7  8  9  10</nobr></div>
<div style="position:absolute;top:9167;left:166"><nobr>Index   0   1   1   2    3   4   4   5  5  5  0</nobr></div>
<div style="position:absolute;top:9186;left:166"><nobr>Since TrajIndex and TrajHead are set to zero, the engine will not move. Current Axis</nobr></div>
<div style="position:absolute;top:9206;left:166"><nobr>Indexes are zero. The App seeing that a move request is in the planner for five steps</nobr></div>
<div style="position:absolute;top:9225;left:166"><nobr>of movement will begin to fill the locations in the ring buffer with data in the index</nobr></div>
<div style="position:absolute;top:9245;left:166"><nobr>locations as above. In this </nobr></div>
<div style="position:absolute;top:9264;left:166"><nobr>Example the App will fill 10 locations and then increment the TrajHeadPointer to 10.</nobr></div>
<div style="position:absolute;top:9284;left:166"><nobr>It does this one step at a time, to start a move, it puts in a index location based on</nobr></div>
<div style="position:absolute;top:9303;left:166"><nobr>acceleration and velocity into the Loc pointed to by TrajHead and then increments the</nobr></div>
<div style="position:absolute;top:9323;left:166"><nobr>head to 1, it repeats this till it gets to the end of the move or the ring buffer is full. In</nobr></div>
<div style="position:absolute;top:9342;left:166"><nobr>this, case the move ends just as the buffer gets to the end. You have to remember that</nobr></div>
<div style="position:absolute;top:9362;left:166"><nobr>the engine is merrily running along. When it sees that the TrajIndex (which is zero) is</nobr></div>
<div style="position:absolute;top:9381;left:166"><nobr>no longer equal to the TrajHead, it grabs the location pointed to by TrajIndex, (in this</nobr></div>
<div style="position:absolute;top:9401;left:166"><nobr>case zero) and compares the current Axis index to that. If they differ (they can only</nobr></div>
<div style="position:absolute;top:9420;left:166"><nobr>differ by a max of 5), it creates a structure, which over the next five interrupts will put</nobr></div>
<div style="position:absolute;top:9440;left:166"><nobr>out the number of steps necessary to have the MasterIndex for that axis match the ring</nobr></div>
<div style="position:absolute;top:9459;left:166"><nobr>buffer index. In this case, zero steps will go out over the next five interrupts. ( 200us).</nobr></div>
<div style="position:absolute;top:9479;left:166"><nobr>The engine ,on completion of that 200us period will them bump the TrajIndex to the</nobr></div>
<div style="position:absolute;top:9498;left:166"><nobr>next position ( 1 ) and will see that now there is a 1 step differential and over the next</nobr></div>
<div style="position:absolute;top:9517;left:166"><nobr>200us will output one step. (The shifter is an 8-bit byte in which only 5 bits are used </nobr></div>
</span></font>

<div style="position:absolute;top:9679;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="9"><b>Page 9</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:9733;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:9732;left:742"><nobr>8</nobr></div>
<div style="position:absolute;top:9810;left:166"><nobr>and indicate the engine which of the five interrupts should output that step.). When</nobr></div>
<div style="position:absolute;top:9829;left:166"><nobr>the TrajIndex reaches 10, it will be equal to the TrajHead and movement will stop. If,</nobr></div>
<div style="position:absolute;top:9849;left:166"><nobr>in the mythical case of our 10 segment ring buffer, the App fills so fast that it reaches</nobr></div>
<div style="position:absolute;top:9868;left:166"><nobr>10 while the TrajIndex is still at zero, the App will simply go into a wait state until it</nobr></div>
<div style="position:absolute;top:9887;left:166"><nobr>sees that the distance from the TrajHead to the TrajIndex is more than a few entries, it</nobr></div>
<div style="position:absolute;top:9907;left:166"><nobr>would then start to fill starting at TrajHead again. In this way, the buffer fills and</nobr></div>
<div style="position:absolute;top:9926;left:166"><nobr>empties automatically. When TrajHead or TrajIndex is 10 and gets incremented, it </nobr></div>
<div style="position:absolute;top:9946;left:166"><nobr>Will be reset to zero and start again from there. </nobr></div>
<div style="position:absolute;top:9965;left:170"><nobr>As the Engine knows only about 200us of data at a time, it obviously does not deal</nobr></div>
<div style="position:absolute;top:9985;left:166"><nobr>with acceleration or ramping, the Application takes care of that by filling the</nobr></div>
<div style="position:absolute;top:10004;left:166"><nobr>appropriate number of steps into each location in the ring buffer. </nobr></div>
<div style="position:absolute;top:10043;left:166"><nobr>Ring Index's   0   1   1   2    3   4   4   5  5  5  0</nobr></div>
<div style="position:absolute;top:10082;left:166"><nobr>In our example, you can see the move slowly move from 0 – 1, then more quickly to</nobr></div>
<div style="position:absolute;top:10102;left:166"><nobr>2, then 3 then slowly from 4 to 5 than stop at 5. This is a shrunken example of a</nobr></div>
<div style="position:absolute;top:10121;left:166"><nobr>ramped move from 0 to 5 for that axis. Therefore, as you can see the ring buffer</nobr></div>
<div style="position:absolute;top:10141;left:166"><nobr>knows nothing of speeds or accels, the resultant speeds from the port are simply a</nobr></div>
<div style="position:absolute;top:10160;left:166"><nobr>timed output</nobr></div>
<div style="position:absolute;top:10180;left:166"><nobr>of the ring buffers information. This is why stopping can be a problem, you cannot</nobr></div>
<div style="position:absolute;top:10199;left:166"><nobr>simply tell it to ramp down, you have to start adding a ramped down motion. Since we</nobr></div>
<div style="position:absolute;top:10218;left:166"><nobr>have 4096 entries, each being 200us long, we have 4096 * .0002 = 819ms of motion</nobr></div>
<div style="position:absolute;top:10238;left:166"><nobr>that may be stored at any time. In faster kernel speeds, the time is less, and at 100</nobr></div>
<div style="position:absolute;top:10258;left:166"><nobr>KHz, the time is only 40ms. This is why you need a very fast CPU to allow for 100</nobr></div>
<div style="position:absolute;top:10277;left:166"><nobr>kHz, because the application will have trouble filling faster than the engine can empty</nobr></div>
<div style="position:absolute;top:10296;left:166"><nobr>the data. You do have to keep in mind that as the App is filling the ring, at the exact</nobr></div>
<div style="position:absolute;top:10316;left:166"><nobr>same time the Engine is hard at work emptying it. This necessitates a very fast filling</nobr></div>
<div style="position:absolute;top:10335;left:166"><nobr>routine in the application. If the application cannot fill fast enough you'll find the</nobr></div>
<div style="position:absolute;top:10355;left:166"><nobr>Buffer Load% on the Diags screen shows 100% quite a bit during a long move. That</nobr></div>
<div style="position:absolute;top:10374;left:166"><nobr>is your clue to slow the kernel.   </nobr></div>
<div style="position:absolute;top:10394;left:166"><nobr>Jogging and other motion is not permitted when the TrajHead is not equal to the</nobr></div>
<div style="position:absolute;top:10413;left:166"><nobr>TrajIndex. Only ring buffer movement will occur if there is data in the ring, and as</nobr></div>
<div style="position:absolute;top:10433;left:166"><nobr>explained above, its all auto magic from the point of view of the application, it only</nobr></div>
<div style="position:absolute;top:10452;left:166"><nobr>fills. It empties as if by magic. </nobr></div>
<div style="position:absolute;top:10492;left:166"><nobr><b>FLOW</b></nobr></div>
<div style="position:absolute;top:10530;left:170"><nobr>As explained, Jogging and such are simply Engine responses to keyboard or</nobr></div>
<div style="position:absolute;top:10550;left:166"><nobr>commands put to the Application. The application is simply filling in structures and</nobr></div>
<div style="position:absolute;top:10569;left:166"><nobr>massaging data to keep the ring filled and the commands flowing, waiting when</nobr></div>
<div style="position:absolute;top:10589;left:166"><nobr>necessary. So lets look at how that all flows. Lets look at the example of what</nobr></div>
<div style="position:absolute;top:10608;left:166"><nobr>happens from the time you load a program to running it. This may be unimportant to</nobr></div>
<div style="position:absolute;top:10628;left:166"><nobr>most, but I suspect its important for some to get a grasp on the actual program flow. </nobr></div>
<div style="position:absolute;top:10667;left:166"><nobr>Mach3, when you load it , loads all your settings, and fills hundreds of variables with</nobr></div>
<div style="position:absolute;top:10686;left:166"><nobr>flags to indicate to it what to do in various situations. When the loading is done it</nobr></div>
<div style="position:absolute;top:10705;left:166"><nobr>doesn’t appear to be doing anything, but in truth Mach3 never sleeps. Its always at </nobr></div>
</span></font>

<div style="position:absolute;top:10867;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="10"><b>Page 10</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:10921;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:10920;left:742"><nobr>9</nobr></div>
<div style="position:absolute;top:10998;left:166"><nobr>work on one or more of hundreds of subtasks. First lets consider what's going on</nobr></div>
<div style="position:absolute;top:11017;left:166"><nobr>when no motion is being commanded and the program is sitting "Idle". </nobr></div>
<div style="position:absolute;top:11056;left:174"><nobr>Mach runs in 1/10 second intervals. That is to say that every 1/10th of a second the</nobr></div>
<div style="position:absolute;top:11075;left:166"><nobr>main system timer is told to start an update process which does the following.</nobr></div>
<div style="position:absolute;top:11114;left:166"><nobr>1)  First, it looks to all controls , each of which are windows of their own. DRO's,</nobr></div>
<div style="position:absolute;top:11134;left:166"><nobr>Buttons, LED's Tickers..ect.. are all told one by one to update themselves. This goes</nobr></div>
<div style="position:absolute;top:11153;left:166"><nobr>much faster than you'd think on a screen with over 800 windows running because only</nobr></div>
<div style="position:absolute;top:11173;left:166"><nobr>visible controls are updated. This is to save time, so the LED's and such on the Diags</nobr></div>
<div style="position:absolute;top:11192;left:166"><nobr>screen when your on the program screen are not updated, they are ignored. But any</nobr></div>
<div style="position:absolute;top:11212;left:166"><nobr>visible control is told to update. This means every LED or DRO is told to check its</nobr></div>
<div style="position:absolute;top:11231;left:166"><nobr>value, and if it differs from the last one displayed, update its display. This is done for</nobr></div>
<div style="position:absolute;top:11251;left:166"><nobr>all visible controls every 1/10 second.  </nobr></div>
<div style="position:absolute;top:11290;left:166"><nobr>2) GCode windows and Toolpaths are told to update. They know internally if</nobr></div>
<div style="position:absolute;top:11309;left:166"><nobr>positions have changed, or the current Gcode line has changed and will redraw to</nobr></div>
<div style="position:absolute;top:11329;left:166"><nobr>reflect that. The GCode display whenever the trajhead is no equal to the trajindex</nobr></div>
<div style="position:absolute;top:11348;left:166"><nobr>pointer will display whatever the current ring buffers ID variable tells it to. This is</nobr></div>
<div style="position:absolute;top:11368;left:166"><nobr>why the GCode display automatically shows the current line.  </nobr></div>
<div style="position:absolute;top:11406;left:166"><nobr>3) Indexes and Inputs are checked to see if they changed, and if they reflect the final</nobr></div>
<div style="position:absolute;top:11426;left:166"><nobr>stage of any known running sequence or wait condition. A macro for example may</nobr></div>
<div style="position:absolute;top:11446;left:166"><nobr>have called SystemWaitFor(INPUT1) , so INPUT1 will be checked to see if that wait</nobr></div>
<div style="position:absolute;top:11465;left:166"><nobr>object may have been canceled by the driver since the last 1/10 interval had passed.</nobr></div>
<div style="position:absolute;top:11484;left:166"><nobr>Its actually the engine that stops the wait condition, so waits are cancelled within 40us</nobr></div>
<div style="position:absolute;top:11504;left:166"><nobr>in most systems in PP mode. </nobr></div>
<div style="position:absolute;top:11543;left:166"><nobr>4) The ring buffer will be checked to see if there was a wait in effect for filling it</nobr></div>
<div style="position:absolute;top:11562;left:166"><nobr>more. In this case motion is in progress, but the system is "idle" while it waits for the</nobr></div>
<div style="position:absolute;top:11582;left:166"><nobr>engine to use up some if its ring buffer data. No sense in filling just one entry so we</nobr></div>
<div style="position:absolute;top:11601;left:166"><nobr>wait till there is at least 500 free slots in the ring. </nobr></div>
<div style="position:absolute;top:11640;left:166"><nobr>5) Any commands requiring processing will be processed. </nobr></div>
<div style="position:absolute;top:11660;left:170"><nobr>Commands can stack up waiting for the Ring buffer to empty for example, or waiting</nobr></div>
<div style="position:absolute;top:11679;left:166"><nobr>for other events to clear prior to allowing them to trigger their actions. Commands</nobr></div>
<div style="position:absolute;top:11699;left:166"><nobr>such as spindle/on or off, waiting macro calls etc, all fall into that category or waiting</nobr></div>
<div style="position:absolute;top:11718;left:166"><nobr>events. </nobr></div>
<div style="position:absolute;top:11738;left:166"><nobr>6) The trajectory planner is checked to see if it has remaining movement. If so, and</nobr></div>
<div style="position:absolute;top:11757;left:166"><nobr>the ringbuffer has room, more moves at 200us intervals are calculated and the ring is</nobr></div>
<div style="position:absolute;top:11777;left:166"><nobr>refilled. </nobr></div>
<div style="position:absolute;top:11816;left:166"><nobr>So when a program is run, the process is to fill the planner with moves up to the</nobr></div>
<div style="position:absolute;top:11835;left:166"><nobr>number of lines set by the lookahead configuration value, OR to the next wait event</nobr></div>
<div style="position:absolute;top:11855;left:166"><nobr>type of command. For example :</nobr></div>
<div style="position:absolute;top:11874;left:166"><nobr>G1X10</nobr></div>
<div style="position:absolute;top:11893;left:166"><nobr>G1Y10 </nobr></div>
</span></font>

<div style="position:absolute;top:12055;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="11"><b>Page 11</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:12109;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:12108;left:732"><nobr>10</nobr></div>
<div style="position:absolute;top:12186;left:166"><nobr>G1Z10</nobr></div>
<div style="position:absolute;top:12205;left:166"><nobr>M5</nobr></div>
<div style="position:absolute;top:12225;left:166"><nobr>G1X0Y0Z0</nobr></div>
<div style="position:absolute;top:12244;left:174"><nobr>Will fill the trajectory planner only up to the M5. When the M5 is interpreted, the</nobr></div>
<div style="position:absolute;top:12263;left:166"><nobr>planner stops getting lines as the "wait event" of a command is added to stop the</nobr></div>
<div style="position:absolute;top:12283;left:166"><nobr>spindle output. Processing of the next line (G1X0Y0Z0) will not even get read from</nobr></div>
<div style="position:absolute;top:12302;left:166"><nobr>the input file until all previous movement has stopped, and then after all commands</nobr></div>
<div style="position:absolute;top:12322;left:166"><nobr>are executed. ( M5) , at that point the last line would get read and executed. As each</nobr></div>
<div style="position:absolute;top:12341;left:166"><nobr>of the first three lines are read, their mixed feedrate is calculated as a function of the</nobr></div>
<div style="position:absolute;top:12361;left:166"><nobr>acceleration settings, max velocities and Feedrate commanded for each axis in the</nobr></div>
<div style="position:absolute;top:12380;left:166"><nobr>mix. Since mixed distances, max velocities, and accelerations of the various axis are</nobr></div>
<div style="position:absolute;top:12400;left:166"><nobr>often at odds with each other, this causes variations in the pulse stream which are</nobr></div>
<div style="position:absolute;top:12419;left:166"><nobr>quite normal, but makes planned motion not as smooth as the Jogging. Since Jogging</nobr></div>
<div style="position:absolute;top:12439;left:166"><nobr>doesn’t have to respect the other axis settings, its movement is more pure and often</nobr></div>
<div style="position:absolute;top:12458;left:166"><nobr>leads to the comment that jogging is superior to GCode motion, unless the various</nobr></div>
<div style="position:absolute;top:12478;left:166"><nobr>axis are well tuned. As each moves motion distance and accel/vel calcs are complete</nobr></div>
<div style="position:absolute;top:12497;left:166"><nobr>they are added to the planner. The planner controls the CV'ing of the lines, as well as</nobr></div>
<div style="position:absolute;top:12517;left:166"><nobr>taking care of making each output equal to 200us , or 5 times the kernel interrupt time</nobr></div>
<div style="position:absolute;top:12536;left:166"><nobr>in faster modes. </nobr></div>
<div style="position:absolute;top:12556;left:174"><nobr>Each pass through the Applications 1/10 second loop, the ring buffer is filled form</nobr></div>
<div style="position:absolute;top:12575;left:166"><nobr>the planner, if it is not empty, and the Engine automatically performs the motion</nobr></div>
<div style="position:absolute;top:12594;left:166"><nobr>required by the ring buffer. While filling the ring buffer the Application recalculates</nobr></div>
<div style="position:absolute;top:12614;left:166"><nobr>the pulse distance averages to further smooth the output timing to make the binary</nobr></div>
<div style="position:absolute;top:12634;left:166"><nobr>frequency stream as mathematically pure as it can be on that interrupt levels time</nobr></div>
<div style="position:absolute;top:12653;left:166"><nobr>base. </nobr></div>
<div style="position:absolute;top:12672;left:179"><nobr>The effect of the time base calculations means that using a higher frequency for</nobr></div>
<div style="position:absolute;top:12692;left:166"><nobr>lower speeds is actually advantageous to the user, BUT has to be traded off to</nobr></div>
<div style="position:absolute;top:12711;left:166"><nobr>processor speed and the power required to fill the buffer </nobr></div>
<div style="position:absolute;top:12731;left:166"><nobr>faster than the engine can empty the buffer. For this reason, and the users pathological</nobr></div>
<div style="position:absolute;top:12750;left:166"><nobr>drive to always use the fastest speed he can thus creating support problems on slower</nobr></div>
<div style="position:absolute;top:12770;left:166"><nobr>computers, my recommendation has always been to use the lowest kernel speed</nobr></div>
<div style="position:absolute;top:12789;left:166"><nobr>possible. Now that computers are faster and I suspect most people use 2Ghz or better</nobr></div>
<div style="position:absolute;top:12809;left:166"><nobr>coming in, I don’t mind admitting that a 60Khz run even with motors that don’t move</nobr></div>
<div style="position:absolute;top:12828;left:166"><nobr>beyond 20khz is the smoothest option to use. Not necessarily the best option, as</nobr></div>
<div style="position:absolute;top:12848;left:166"><nobr>system criticality has to be considered. ( A 4096 buffer at 60Khz holds only 341ms as</nobr></div>
<div style="position:absolute;top:12867;left:166"><nobr>opposed to the 819ms buffer of 25Khz mode. ). Since things like feedhold need to</nobr></div>
<div style="position:absolute;top:12887;left:166"><nobr>start adding a ramped down move to the ring buffer, 25Khz mode will take up to a</nobr></div>
<div style="position:absolute;top:12906;left:166"><nobr>max of 819ms to start to slow, while 60Khz will take only 341ms. Almost three times</nobr></div>
<div style="position:absolute;top:12926;left:166"><nobr>as fast. So things such as that need to be factored into the decision as to what settings</nobr></div>
<div style="position:absolute;top:12945;left:166"><nobr>to use. The faster you select the better your response, but the easier it will be to lose</nobr></div>
<div style="position:absolute;top:12965;left:166"><nobr>steps by switching screens or starting your email program and such. </nobr></div>
<div style="position:absolute;top:13004;left:166"><nobr><b>TIMING</b></nobr></div>
<div style="position:absolute;top:13023;left:179"><nobr>Mach3 uses Interrupt 0, which is a very powerful interrupt, but the one enemy of</nobr></div>
<div style="position:absolute;top:13043;left:166"><nobr>this is the DMA cycle. DMA , when it occurs to get Hard disk data, or to send audio</nobr></div>
<div style="position:absolute;top:13062;left:166"><nobr>data, CAN stop the timer because the processor doesn’t see DMA transfers, the CPU</nobr></div>
<div style="position:absolute;top:13081;left:166"><nobr>simply goes to sleep for a bit and Windows doesn’t see that anything has occurred, </nobr></div>
</span></font>

<div style="position:absolute;top:13243;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="12"><b>Page 12</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:13297;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:13296;left:732"><nobr>11</nobr></div>
<div style="position:absolute;top:13374;left:166"><nobr>nor does the Engine. Small disk transfers will have no effect as they are typically less</nobr></div>
<div style="position:absolute;top:13393;left:166"><nobr>than the period of one interrupt, but large transfers can cause lost steps as the pulse</nobr></div>
<div style="position:absolute;top:13413;left:166"><nobr>timings get ragged. So pick a speed for your system that takes all the above into</nobr></div>
<div style="position:absolute;top:13432;left:166"><nobr>account, and at all times refrain from doing other work while cutting, specifically</nobr></div>
<div style="position:absolute;top:13451;left:166"><nobr>those that cause a lot of disk traffic. </nobr></div>
<div style="position:absolute;top:13490;left:166"><nobr><b>Loading</b>:</nobr></div>
<div style="position:absolute;top:13529;left:179"><nobr>When you select a program to load, mach will clear any buffers it has. It then sets</nobr></div>
<div style="position:absolute;top:13549;left:166"><nobr>flags to tell the engine any movement is fake and not to send it out. The loader then</nobr></div>
<div style="position:absolute;top:13568;left:166"><nobr>simply sets the current line to zero and tells the program to run. It does make a copy</nobr></div>
<div style="position:absolute;top:13588;left:166"><nobr>of the current state engine as well just in case any dangling states are left set. It</nobr></div>
<div style="position:absolute;top:13607;left:166"><nobr>restores the state back to start conditions after the initial load/run.  When the planner</nobr></div>
<div style="position:absolute;top:13627;left:166"><nobr>sees that the Engine is set to loading mode, it runs very fast. Instead of 200us per</nobr></div>
<div style="position:absolute;top:13646;left:166"><nobr>move, the planner will run though moves at 6ms per move. This means a file typically</nobr></div>
<div style="position:absolute;top:13666;left:166"><nobr>runs at 30 times faster than normal. This allows it to run the file quickly both as a way</nobr></div>
<div style="position:absolute;top:13685;left:166"><nobr>to generate a toolpath as well as a way to check for errors. If any line triggers an error</nobr></div>
<div style="position:absolute;top:13705;left:166"><nobr>during a load run, the Gcode display stop motion, the program is halted and the error</nobr></div>
<div style="position:absolute;top:13724;left:166"><nobr>is put out on the status line. </nobr></div>
<div style="position:absolute;top:13744;left:174"><nobr>During the run, a database file "display.dat" is created with a list of moves in it, this</nobr></div>
<div style="position:absolute;top:13763;left:166"><nobr>list is used to display the toolpath and to create offset information for the G41/G42</nobr></div>
<div style="position:absolute;top:13782;left:166"><nobr>offsets in there are any in the file. In fact, if G41/G42 is used, the file is run twice,</nobr></div>
<div style="position:absolute;top:13802;left:166"><nobr>once to see the original moves, and a second time to calculate offsets from them to</nobr></div>
<div style="position:absolute;top:13822;left:166"><nobr>display in white on the toolpath.</nobr></div>
<div style="position:absolute;top:13841;left:166"><nobr>The addition toolpath display of the comped moves is stored in a file called</nobr></div>
<div style="position:absolute;top:13860;left:166"><nobr>CompDisplay.dat .  </nobr></div>
<div style="position:absolute;top:13899;left:174"><nobr>Once run through, the file is rewound even if not told to so the display will start at</nobr></div>
<div style="position:absolute;top:13919;left:166"><nobr>zero after a load. You are then ready to press cycle start as long as the unit is not in</nobr></div>
<div style="position:absolute;top:13938;left:166"><nobr>Estop mode.</nobr></div>
<div style="position:absolute;top:13977;left:166"><nobr><b>EStop &amp; Safe Mode</b>:</nobr></div>
<div style="position:absolute;top:14016;left:179"><nobr>In the interests of safety, Mach3 always starts in EStop mode with the flashing</nobr></div>
<div style="position:absolute;top:14036;left:166"><nobr>Estop button. There are 6 enable outputs that are tied to this operation. They are</nobr></div>
<div style="position:absolute;top:14055;left:166"><nobr>programmed to turn on , one by one with a couple hundred ms of time between each</nobr></div>
<div style="position:absolute;top:14075;left:166"><nobr>one. This is to stop excessive current being drawn from your power supplies as all the</nobr></div>
<div style="position:absolute;top:14094;left:166"><nobr>drivers get enabled at once. Many don’t use that feature but it is there for that purpose.</nobr></div>
<div style="position:absolute;top:14114;left:166"><nobr>Having the drive power up from the enable lines can be problematic for some as the</nobr></div>
<div style="position:absolute;top:14133;left:166"><nobr>power is removed from them whenever an Estop occurs, but in terms of safety it is a</nobr></div>
<div style="position:absolute;top:14153;left:166"><nobr>good idea to have a main relay kill all motor mower anyway when an Estop occurs.</nobr></div>
<div style="position:absolute;top:14172;left:166"><nobr>So enabling each drive with an Enable signal is a good way to stop the high current at</nobr></div>
<div style="position:absolute;top:14192;left:166"><nobr>startup of the system.</nobr></div>
<div style="position:absolute;top:14211;left:174"><nobr>Allot of things will trigger an Estop, limit switches, Soft limits and a few other</nobr></div>
<div style="position:absolute;top:14231;left:166"><nobr>things. The Engine is responsible for most of them as it can respond very quickly</nobr></div>
<div style="position:absolute;top:14250;left:166"><nobr>within one interrupt period. The Debounce setting in the config simply tells the engine</nobr></div>
<div style="position:absolute;top:14269;left:166"><nobr>that any signal is to be ignored unless it is seen to be active in a Debounce number of </nobr></div>
</span></font>

<div style="position:absolute;top:14431;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="13"><b>Page 13</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:14485;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:14484;left:732"><nobr>12</nobr></div>
<div style="position:absolute;top:14562;left:166"><nobr>consecutive interrupts. So a debounce of 1000 at 25000 mode is 40us * 1000 or 40ms</nobr></div>
<div style="position:absolute;top:14581;left:166"><nobr>of time.</nobr></div>
<div style="position:absolute;top:14601;left:170"><nobr>Pressing the Rest makes you go into "Safe" mode where the Estop stops flashing and</nobr></div>
<div style="position:absolute;top:14620;left:166"><nobr>your ready to go. Of course the EStop button checks to make sure its allowed to reset</nobr></div>
<div style="position:absolute;top:14639;left:166"><nobr>before doing so. Warnings are sent to tell you why it wont reset it there is a problem.</nobr></div>
<div style="position:absolute;top:14679;left:166"><nobr><b>INPUTS &amp; OUTPUTS</b></nobr></div>
<div style="position:absolute;top:14698;left:174"><nobr>The engine handles inputs and outputs as simple semaphore triggered events. There</nobr></div>
<div style="position:absolute;top:14717;left:166"><nobr>is a memory structure called InSigs in the Engine and one called OutSigs. There are</nobr></div>
<div style="position:absolute;top:14737;left:166"><nobr>53 input signals, and 30 output signals. They are based on the following two</nobr></div>
<div style="position:absolute;top:14756;left:166"><nobr>structures. </nobr></div>
<div style="position:absolute;top:14776;left:166"><nobr>// output signal structure</nobr></div>
<div style="position:absolute;top:14815;left:166"><nobr>struct OutputInfo</nobr></div>
<div style="position:absolute;top:14834;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:14854;left:183"><nobr>bool active;</nobr></div>
<div style="position:absolute;top:14873;left:227"><nobr>char OutPin;</nobr></div>
<div style="position:absolute;top:14893;left:227"><nobr>char OutPort;</nobr></div>
<div style="position:absolute;top:14912;left:227"><nobr>bool Negated;</nobr></div>
<div style="position:absolute;top:14932;left:227"><nobr>bool Activated;</nobr></div>
<div style="position:absolute;top:14951;left:166"><nobr>};</nobr></div>
<div style="position:absolute;top:15010;left:166"><nobr>// input signal structure</nobr></div>
<div style="position:absolute;top:15029;left:166"><nobr>struct  InputInfo</nobr></div>
<div style="position:absolute;top:15048;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:15068;left:183"><nobr>bool  Active;     // signal active?</nobr></div>
<div style="position:absolute;top:15087;left:227"><nobr>char  InPin;     // which Pin</nobr></div>
<div style="position:absolute;top:15107;left:227"><nobr>char  InPort;     // which Port</nobr></div>
<div style="position:absolute;top:15126;left:227"><nobr>bool  Negated;</nobr></div>
<div style="position:absolute;top:15146;left:183"><nobr>int   ReqState;   // Required State on Activation</nobr></div>
<div style="position:absolute;top:15165;left:227"><nobr>bool  Activated;</nobr></div>
<div style="position:absolute;top:15185;left:227"><nobr>bool  Emulated;</nobr></div>
<div style="position:absolute;top:15204;left:227"><nobr>int   EmulationKey;</nobr></div>
<div style="position:absolute;top:15224;left:166"><nobr>};</nobr></div>
<div style="position:absolute;top:15243;left:174"><nobr>Each input and output is named, but that’s a simple defined number from 0 to</nobr></div>
<div style="position:absolute;top:15263;left:166"><nobr>maxsignals for either array of structures. If the Active variable is set to true, the</nobr></div>
<div style="position:absolute;top:15282;left:166"><nobr>system considers that signal to be turned on. The Port and pin tells the engine to fill or</nobr></div>
<div style="position:absolute;top:15302;left:166"><nobr>trigger that signal depending on the port number. If the port is 1 or 2, then the Engine</nobr></div>
<div style="position:absolute;top:15321;left:166"><nobr>will handle the signal, if it is not, then a plug-in is considered to be in charge of that</nobr></div>
<div style="position:absolute;top:15341;left:166"><nobr>signal. The Activated variable tells the engine if the signal is on or off, and the</nobr></div>
<div style="position:absolute;top:15360;left:166"><nobr>LowActive tells the engine to trigger a high or low output on the requested pin, or to</nobr></div>
<div style="position:absolute;top:15380;left:166"><nobr>see an incoming high or low as "active" to set the activated variable in an input signal</nobr></div>
<div style="position:absolute;top:15399;left:166"><nobr>structure. For input signals keyboard emulation can be used and that’s the other</nobr></div>
<div style="position:absolute;top:15419;left:166"><nobr>variables in the insig structure.  If the port is not port 1 or 2 though, the engine will do</nobr></div>
<div style="position:absolute;top:15438;left:166"><nobr>nothing with that input or output. A Plug-in will then be expected to fill those</nobr></div>
<div style="position:absolute;top:15457;left:166"><nobr>variables. Mach3 will check the inputs each 1/10 second to see if anything needs to be </nobr></div>
</span></font>

<div style="position:absolute;top:15619;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="14"><b>Page 14</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:15673;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:15672;left:732"><nobr>13</nobr></div>
<div style="position:absolute;top:15750;left:166"><nobr>done once a signal triggers, but for time critical inputs such as EStop , limits or</nobr></div>
<div style="position:absolute;top:15769;left:166"><nobr>probing, the Engine will handle what needs to be done as only it can respond fast</nobr></div>
<div style="position:absolute;top:15789;left:166"><nobr>enough. </nobr></div>
<div style="position:absolute;top:15828;left:166"><nobr><b>MACROS</b></nobr></div>
<div style="position:absolute;top:15847;left:174"><nobr>Mach3 uses the Cypress VB engine to accept scripts and user macros. This is done</nobr></div>
<div style="position:absolute;top:15866;left:166"><nobr>by a Macro thread, which responds whenever it sees that a CString variable "Macro"</nobr></div>
<div style="position:absolute;top:15886;left:166"><nobr>has been set. Any script macro requested is first held till all movement stops and the</nobr></div>
<div style="position:absolute;top:15905;left:166"><nobr>ring buffer is empty, then the macro command in translated to the proper file which is</nobr></div>
<div style="position:absolute;top:15925;left:166"><nobr>then loaded and the text placed in the Macro variable. This has a maximum of 65000</nobr></div>
<div style="position:absolute;top:15944;left:166"><nobr>characters. When the variable contains a text input, the Macro thread will</nobr></div>
<div style="position:absolute;top:15964;left:166"><nobr>automatically run that script, then empty the variable, and the program will continue.</nobr></div>
<div style="position:absolute;top:15983;left:166"><nobr>This is why a macro cannot call another macro. The threader only looks to one</nobr></div>
<div style="position:absolute;top:16003;left:166"><nobr>variable for text and there is no secondary storage for another script. The code is a bit</nobr></div>
<div style="position:absolute;top:16022;left:166"><nobr>weak there and will likely be strengthened over time as it’s a complex connection to</nobr></div>
<div style="position:absolute;top:16042;left:166"><nobr>get just right. When a script is loaded certain constants are loaded with it such as</nobr></div>
<div style="position:absolute;top:16061;left:166"><nobr>Sleep , the names of the signals, ( INPUT1 , OUTPUT1 ..ect. ),and the scripts may</nobr></div>
<div style="position:absolute;top:16081;left:166"><nobr>avail themselves of those constant declarations. </nobr></div>
<div style="position:absolute;top:16120;left:166"><nobr><b>Encoders &amp; MPG's</b></nobr></div>
<div style="position:absolute;top:16158;left:174"><nobr>On each interrupt the engine will also count encoder positions and track the counts.</nobr></div>
<div style="position:absolute;top:16178;left:166"><nobr>These counts are put in the following structures of which 7 copies are maintained.</nobr></div>
<div style="position:absolute;top:16198;left:166"><nobr>Four for simple encoders and 3 for MPG's. </nobr></div>
<div style="position:absolute;top:16236;left:166"><nobr>struct Encoder</nobr></div>
<div style="position:absolute;top:16256;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:16275;left:227"><nobr>bool Active;  // is the encoder turned on?</nobr></div>
<div style="position:absolute;top:16295;left:227"><nobr>int  APin;    //  A Pin designations</nobr></div>
<div style="position:absolute;top:16314;left:227"><nobr>int  BPin;    //  B Pin designations</nobr></div>
<div style="position:absolute;top:16334;left:227"><nobr>int  APort;   //  A Pin Ports</nobr></div>
<div style="position:absolute;top:16353;left:227"><nobr>int  BPort;   //  B Pin Ports</nobr></div>
<div style="position:absolute;top:16373;left:227"><nobr>bool LastStateA;</nobr></div>
<div style="position:absolute;top:16392;left:227"><nobr>bool LastStateB;  // storage for the last known state</nobr></div>
<div style="position:absolute;top:16412;left:227"><nobr>int  Count[2];  //  Index counts for each encoder</nobr></div>
<div style="position:absolute;top:16431;left:227"><nobr>int  Memory[16];</nobr></div>
<div style="position:absolute;top:16451;left:227"><nobr>int  ActiveMemory;</nobr></div>
<div style="position:absolute;top:16470;left:227"><nobr>int  Color;</nobr></div>
<div style="position:absolute;top:16509;left:166"><nobr>};   </nobr></div>
<div style="position:absolute;top:16529;left:170"><nobr>The same rules apply as for inputs and outputs. If the port number is not 1 or 2, then</nobr></div>
<div style="position:absolute;top:16548;left:166"><nobr>the engine will not fill those variables and a plug-in or Brain is expected to do so if</nobr></div>
<div style="position:absolute;top:16568;left:166"><nobr>they are enabled.  On each loop of the applications run it will check the MPG and</nobr></div>
<div style="position:absolute;top:16587;left:166"><nobr>encoder values, update any DRO's involved and , if the jog mode is set to MPG will</nobr></div>
<div style="position:absolute;top:16607;left:166"><nobr>move the axis in correspondence with the MPG mode in effect. The only reason</nobr></div>
<div style="position:absolute;top:16626;left:166"><nobr>MPG's must be switched on is that when the MPG stops and its velocity is zero the</nobr></div>
<div style="position:absolute;top:16645;left:166"><nobr>DEC variable of the jog registers is set to true to auto stop any jog. A rewrite of this </nobr></div>
</span></font>

<div style="position:absolute;top:16807;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="15"><b>Page 15</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:16861;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:16860;left:732"><nobr>14</nobr></div>
<div style="position:absolute;top:16938;left:166"><nobr>will likely allow for Jogging via MPG at any time and will probably be done in future.</nobr></div>
<div style="position:absolute;top:16957;left:166"><nobr>When doing an MPG jog the current velocity of the MPG must be calculated by the</nobr></div>
<div style="position:absolute;top:16977;left:166"><nobr>application if in printer port mode, or sent in via brain or plug-in if using plugins or</nobr></div>
<div style="position:absolute;top:16996;left:166"><nobr>modbus devices to set the mpg. Examples of the timing clock interface are in the</nobr></div>
<div style="position:absolute;top:17015;left:166"><nobr>current example brains showing a g100 using a MPG from its encoder inputs.  </nobr></div>
<div style="position:absolute;top:17055;left:166"><nobr><b>MODBUS </b></nobr></div>
<div style="position:absolute;top:17074;left:166"><nobr>Modbus connections to Mach3 can be made as Serial or TCP.  Each selection uses its</nobr></div>
<div style="position:absolute;top:17093;left:166"><nobr>own thread with an update timer of 25ms to control its IO. Its best to think of ModBus</nobr></div>
<div style="position:absolute;top:17113;left:166"><nobr>simply as a way to fill certain memory blocks in Mach3 with data. In the case of</nobr></div>
<div style="position:absolute;top:17132;left:166"><nobr>Serial mode ModBus, there are two data structures ( MasterInputs[1024] and</nobr></div>
<div style="position:absolute;top:17152;left:166"><nobr>MasterOuputs[1024] which are filled with data from a modbus device, or used to send</nobr></div>
<div style="position:absolute;top:17171;left:166"><nobr>data to a ModBus device in a timed way. In the case of TCP ModBus or Serial Plug-in</nobr></div>
<div style="position:absolute;top:17191;left:166"><nobr>Modbus, two different structures are used as the ModCon block. </nobr></div>
<div style="position:absolute;top:17210;left:166"><nobr>struct ModCfg</nobr></div>
<div style="position:absolute;top:17230;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:17249;left:170"><nobr>short Data[128];</nobr></div>
<div style="position:absolute;top:17269;left:170"><nobr>char Comment[80];</nobr></div>
<div style="position:absolute;top:17288;left:170"><nobr>bool Enabled;</nobr></div>
<div style="position:absolute;top:17308;left:170"><nobr>int ModAdd; //modbus address</nobr></div>
<div style="position:absolute;top:17327;left:170"><nobr>int nReg;</nobr></div>
<div style="position:absolute;top:17346;left:170"><nobr>int Input;</nobr></div>
<div style="position:absolute;top:17366;left:170"><nobr>int Port;</nobr></div>
<div style="position:absolute;top:17386;left:170"><nobr>int Slave;</nobr></div>
<div style="position:absolute;top:17405;left:170"><nobr>int Refresh;</nobr></div>
<div style="position:absolute;top:17424;left:170"><nobr>int timref;</nobr></div>
<div style="position:absolute;top:17444;left:170"><nobr>int status;</nobr></div>
<div style="position:absolute;top:17463;left:170"><nobr>char msgstatus[40];</nobr></div>
<div style="position:absolute;top:17483;left:166"><nobr>};</nobr></div>
<div style="position:absolute;top:17522;left:166"><nobr>struct ModCon</nobr></div>
<div style="position:absolute;top:17541;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:17561;left:174"><nobr>ModCfg cgf[65];</nobr></div>
<div style="position:absolute;top:17580;left:166"><nobr>};</nobr></div>
<div style="position:absolute;top:17600;left:174"><nobr>The ModCon structure then contains 65 copies of the ModCFG structure. Every</nobr></div>
<div style="position:absolute;top:17619;left:166"><nobr>25ms or so , the ModBus facility looks at each of the 65 cgf's in the ModCon and</nobr></div>
<div style="position:absolute;top:17639;left:166"><nobr>determines from its variables if data needs to be transfered into or out of the</nobr></div>
<div style="position:absolute;top:17658;left:166"><nobr>Data[128] block of that cgf. The end result is all the 65 Data[128] structures are sent</nobr></div>
<div style="position:absolute;top:17678;left:166"><nobr>or received as programmed by the various variables setup in the config/modbus</nobr></div>
<div style="position:absolute;top:17697;left:166"><nobr>settings in those modes. The data are then used by Brains to effect logical operations</nobr></div>
<div style="position:absolute;top:17717;left:166"><nobr>which may otherwise have been impossible. For example a Brain could be told to</nobr></div>
<div style="position:absolute;top:17736;left:166"><nobr>look in the ModCon at cgf[10] in data[12] and if bit #1 is set turn on the Estop. I wont</nobr></div>
<div style="position:absolute;top:17756;left:166"><nobr>explain the Brain interface to that level, but one should keep in mind the only true</nobr></div>
<div style="position:absolute;top:17775;left:166"><nobr>function of the ModBus interface is to get and send data from a plc type of device.</nobr></div>
<div style="position:absolute;top:17795;left:166"><nobr>From there the logic is based purely on script work or Brains work. In the case of</nobr></div>
<div style="position:absolute;top:17814;left:166"><nobr>Serial ModBus macros are typically used, though Brains can also be used, while in the </nobr></div>
</span></font>

<div style="position:absolute;top:17995;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="16"><b>Page 16</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:18049;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:18048;left:732"><nobr>15</nobr></div>
<div style="position:absolute;top:18126;left:166"><nobr>case of TCP ModBus or Serial PlugIn ModBus the Brain subsystem is the only way to</nobr></div>
<div style="position:absolute;top:18145;left:166"><nobr>deal with the data. </nobr></div>
<div style="position:absolute;top:18165;left:170"><nobr>There are various Doc files and Videos that explain the scripting and Brain process in</nobr></div>
<div style="position:absolute;top:18184;left:166"><nobr>fairly good detail so we wont go into small details here. Suffice it to say that Brains</nobr></div>
<div style="position:absolute;top:18203;left:166"><nobr>are dealt with every 1/10 second and are seriously fast. Much faster than VB Scripts</nobr></div>
<div style="position:absolute;top:18223;left:166"><nobr>and can be considered instantaneous in most instances taking only 1 – 4us to do their</nobr></div>
<div style="position:absolute;top:18242;left:166"><nobr>job. They aren’t meant for huge logic projects but rather as nice simple routines to</nobr></div>
<div style="position:absolute;top:18262;left:166"><nobr>allow for minor IO flexibility in terms of what a signal from a plc can control. </nobr></div>
<div style="position:absolute;top:18301;left:166"><nobr><b>PLUGINS</b></nobr></div>
<div style="position:absolute;top:18320;left:174"><nobr>Ahh, to the meat of the matter. Most readers of this document will probably have</nobr></div>
<div style="position:absolute;top:18340;left:166"><nobr>plugins in mind. A Plug-In can do virtually anything, it has allot of power over how</nobr></div>
<div style="position:absolute;top:18359;left:166"><nobr>mach3 responds to the user. It can modify present capability or add functionality not</nobr></div>
<div style="position:absolute;top:18379;left:166"><nobr>in the core program. It has a steep learning curve however, but I've been surprised by</nobr></div>
<div style="position:absolute;top:18398;left:166"><nobr>a few who have done amazing things in plugins without a single question to me as to</nobr></div>
<div style="position:absolute;top:18418;left:166"><nobr>how to do it. Those individuals are truly at the top of their game to be able to do so.</nobr></div>
<div style="position:absolute;top:18437;left:166"><nobr>Even I stumble in Plug-in work at times. We will examine plugins closely to aid in</nobr></div>
<div style="position:absolute;top:18457;left:166"><nobr>not only their use, but in their creation in terms of what can and cannot be done. </nobr></div>
<div style="position:absolute;top:18496;left:179"><nobr>Many examples are around for plugins. We'll use one here that controls a mythical</nobr></div>
<div style="position:absolute;top:18515;left:166"><nobr>device called the "ServoRun" Device. The "ServoRun" was invented by Einstein, it</nobr></div>
<div style="position:absolute;top:18534;left:166"><nobr>has a perfect command set, never loses a step, and is very fast. Its interface is simpler</nobr></div>
<div style="position:absolute;top:18554;left:166"><nobr>than most devices (Being perfect) and so we should have no trouble writing a plug-in</nobr></div>
<div style="position:absolute;top:18574;left:166"><nobr>for it here. </nobr></div>
<div style="position:absolute;top:18612;left:179"><nobr>The files for a plug-in comprise only a few, but a large includes folder. The includes</nobr></div>
<div style="position:absolute;top:18632;left:166"><nobr>folder allows access to many if not most of the underlying variables in Mach3. This</nobr></div>
<div style="position:absolute;top:18651;left:166"><nobr>includes the Block of shared memory , the App, and the Engine itself.  The Engine is</nobr></div>
<div style="position:absolute;top:18671;left:166"><nobr>still used in external device plugins as they are simply expected to emulate the</nobr></div>
<div style="position:absolute;top:18690;left:166"><nobr>engines use of the printer port in many instances. Lets develop one from scratch with</nobr></div>
<div style="position:absolute;top:18710;left:166"><nobr>more explanation than has been given before so one can see exactly how to write a</nobr></div>
<div style="position:absolute;top:18729;left:166"><nobr>plug-in. Keep in mind that other types of Plugins are easier to write , simple IO or</nobr></div>
<div style="position:absolute;top:18749;left:166"><nobr>video don’t need to interface quite as tightly as a motion interface, but the theory is</nobr></div>
<div style="position:absolute;top:18768;left:166"><nobr>the same, think of a plug-in as simply dealing with all the shared memory of Mach3, </nobr></div>
<div style="position:absolute;top:18788;left:166"><nobr>while the App deals with the vast majority of the logic to keep things running.. </nobr></div>
<div style="position:absolute;top:18827;left:166"><nobr>Required File: MachDevice.cpp , MachDevice.h , ( and folder MachIncludes )</nobr></div>
<div style="position:absolute;top:18846;left:174"><nobr>These file contain all the routines that Mach3 will call. Its good programming</nobr></div>
<div style="position:absolute;top:18866;left:166"><nobr>practice to have a </nobr></div>
<div style="position:absolute;top:18885;left:166"><nobr>File called MachDevImplementation.cpp which contains calls referenced by the</nobr></div>
<div style="position:absolute;top:18905;left:166"><nobr>MachDevice.cpp calls. This makes the MachDevice.app a file which needs no</nobr></div>
<div style="position:absolute;top:18924;left:166"><nobr>modification when you write a plug-in. Or at the very most only minor modifications.</nobr></div>
<div style="position:absolute;top:18944;left:166"><nobr>In MachDevice you will see the Mach3 hooks and pointers that are used. Its my</nobr></div>
<div style="position:absolute;top:18963;left:166"><nobr>experience that many C++ programmers are not really comfortable with pointers and</nobr></div>
<div style="position:absolute;top:18983;left:166"><nobr>pointer recasting, so the MachDevice.cpp can , for some, be considered a black box</nobr></div>
<div style="position:absolute;top:19002;left:166"><nobr>operating in a magical mode where its only purpose is to make sure the routines in </nobr></div>
</span></font>

<div style="position:absolute;top:19183;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="17"><b>Page 17</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:19237;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:19236;left:732"><nobr>16</nobr></div>
<div style="position:absolute;top:19314;left:166"><nobr>MachDevImplementation.cpp at the proper times. We'll take a look here though at</nobr></div>
<div style="position:absolute;top:19333;left:166"><nobr>exactly what MachDevice.cpp does..</nobr></div>
<div style="position:absolute;top:19353;left:170"><nobr>We'll start with the .h file which defines many things used by MachDevice.cpp. Here</nobr></div>
<div style="position:absolute;top:19372;left:166"><nobr>is a current MachDevice.h 's internals from top to bottom. We start with some pointer</nobr></div>
<div style="position:absolute;top:19391;left:166"><nobr>type declarations.</nobr></div>
<div style="position:absolute;top:19411;left:166"><nobr>typedef void (CALLBACK *NoParms) ();</nobr></div>
<div style="position:absolute;top:19430;left:166"><nobr>typedef void (_cdecl *OneShort) ( short );</nobr></div>
<div style="position:absolute;top:19450;left:166"><nobr>typedef double (_cdecl *DoubleShort) ( short );</nobr></div>
<div style="position:absolute;top:19469;left:166"><nobr>typedef void (_cdecl *VoidShortDouble) ( short , double );</nobr></div>
<div style="position:absolute;top:19489;left:166"><nobr>typedef bool (_cdecl *BoolShort) ( short );</nobr></div>
<div style="position:absolute;top:19508;left:166"><nobr>typedef void (_cdecl *CSTRret) ( CString );</nobr></div>
<div style="position:absolute;top:19528;left:166"><nobr>typedef void (_cdecl *VoidLPCSTR) (LPCTSTR );</nobr></div>
<div style="position:absolute;top:19547;left:166"><nobr>typedef void (_cdecl *VoidShortBool) ( short, bool );</nobr></div>
<div style="position:absolute;top:19567;left:166"><nobr>typedef int  (_cdecl *IntShort) ( short );</nobr></div>
<div style="position:absolute;top:19625;left:174"><nobr>These declarations tell the compiler what Mach3 will expect for some types of</nobr></div>
<div style="position:absolute;top:19645;left:166"><nobr>functions. DLL's , as a rule are meant to contain code to be called by an application.</nobr></div>
<div style="position:absolute;top:19664;left:166"><nobr>They are not generally meant to allow for the DLL to call the main application on</nobr></div>
<div style="position:absolute;top:19684;left:166"><nobr>their own. This made it necessary to redirect some functions and create backward</nobr></div>
<div style="position:absolute;top:19703;left:166"><nobr>hooks for them In the list above for example, the VoidShortBool declaration is a way</nobr></div>
<div style="position:absolute;top:19722;left:166"><nobr>of telling the compiler that any function declared as VoidShortBool is actually a</nobr></div>
<div style="position:absolute;top:19742;left:166"><nobr>function declared in Mach3 as </nobr></div>
<div style="position:absolute;top:19762;left:166"><nobr>Void  Function( short, bool ); , so though it looks complex to programmers not used to</nobr></div>
<div style="position:absolute;top:19781;left:166"><nobr>pointer indirection, its really just syntax necessary due to using the dll to call the main</nobr></div>
<div style="position:absolute;top:19800;left:166"><nobr>application.. </nobr></div>
<div style="position:absolute;top:19820;left:170"><nobr>The only other thing in the h file is </nobr></div>
<div style="position:absolute;top:19839;left:166"><nobr>class CMachDeviceApp : public CWinApp</nobr></div>
<div style="position:absolute;top:19859;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:19878;left:166"><nobr>public:</nobr></div>
<div style="position:absolute;top:19898;left:227"><nobr>CMachDeviceApp();</nobr></div>
<div style="position:absolute;top:19917;left:227"><nobr>~CMachDeviceApp();</nobr></div>
<div style="position:absolute;top:19976;left:166"><nobr>// Overrides</nobr></div>
<div style="position:absolute;top:19995;left:166"><nobr>public:</nobr></div>
<div style="position:absolute;top:20015;left:227"><nobr>virtual BOOL InitInstance();</nobr></div>
<div style="position:absolute;top:20054;left:227"><nobr>DECLARE_MESSAGE_MAP()</nobr></div>
<div style="position:absolute;top:20093;left:166"><nobr>};</nobr></div>
<div style="position:absolute;top:20112;left:174"><nobr>which simply declares the CMachDeviceApp as an application of its own, with full</nobr></div>
<div style="position:absolute;top:20132;left:166"><nobr>power to create and maintain windows of its own if it so desires. </nobr></div>
<div style="position:absolute;top:20151;left:174"><nobr>Now if we look to the .cpp implementation of the device mush more will become</nobr></div>
<div style="position:absolute;top:20171;left:166"><nobr>clear as to the actual interface.</nobr></div>
<div style="position:absolute;top:20190;left:170"><nobr>We start with the normal defines of course,  and then define as external any routines</nobr></div>
<div style="position:absolute;top:20209;left:166"><nobr>we wish the device to be able to call. This means if you add a routine to the device, </nobr></div>
</span></font>

<div style="position:absolute;top:20371;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="18"><b>Page 18</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:20425;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:20424;left:732"><nobr>17</nobr></div>
<div style="position:absolute;top:20502;left:166"><nobr>you will need to then create a new routine in the MachDevImplementation.cpp and</nobr></div>
<div style="position:absolute;top:20521;left:166"><nobr>add an external reference here. Heres what is in most MachDevice.cpp files at this</nobr></div>
<div style="position:absolute;top:20541;left:166"><nobr>point..</nobr></div>
<div style="position:absolute;top:20560;left:166"><nobr>extern CString myProfileInit (CString, CXMLProfile*);    </nobr></div>
<div style="position:absolute;top:20560;left:593"><nobr>// initial access to</nobr></div>
<div style="position:absolute;top:20579;left:166"><nobr>Mach profile</nobr></div>
<div style="position:absolute;top:20599;left:437"><nobr>// when enumerating available plugins</nobr></div>
<div style="position:absolute;top:20618;left:166"><nobr>extern void myInitControl ();    </nobr></div>
<div style="position:absolute;top:20618;left:512"><nobr>// called during Mach initialisation</nobr></div>
<div style="position:absolute;top:20638;left:437"><nobr>// you can influence subsequent init by actions</nobr></div>
<div style="position:absolute;top:20657;left:166"><nobr>here</nobr></div>
<div style="position:absolute;top:20677;left:437"><nobr>// **** Not used in typical device plugin</nobr></div>
<div style="position:absolute;top:20696;left:166"><nobr>extern void myPostInitControl ();    </nobr></div>
<div style="position:absolute;top:20696;left:525"><nobr>// called when mach fully set up</nobr></div>
<div style="position:absolute;top:20716;left:166"><nobr>extern void myConfig (CXMLProfile*);    </nobr></div>
<div style="position:absolute;top:20716;left:558"><nobr>// Called to configure the</nobr></div>
<div style="position:absolute;top:20735;left:166"><nobr>device</nobr></div>
<div style="position:absolute;top:20774;left:166"><nobr>extern void myUpdate ();    </nobr></div>
<div style="position:absolute;top:20774;left:507"><nobr>// 10Hz update loop</nobr></div>
<div style="position:absolute;top:20794;left:166"><nobr>extern void myHighSpeedUpdate ();    </nobr></div>
<div style="position:absolute;top:20794;left:544"><nobr>// called at 40Hz</nobr></div>
<div style="position:absolute;top:20833;left:166"><nobr>extern void myCleanUp();    </nobr></div>
<div style="position:absolute;top:20833;left:535"><nobr>//Destrucion routine for</nobr></div>
<div style="position:absolute;top:20852;left:166"><nobr>clenaup.</nobr></div>
<div style="position:absolute;top:20891;left:166"><nobr>extern void myNotify(int message);    </nobr></div>
<div style="position:absolute;top:20891;left:536"><nobr>// you can influence subsequent</nobr></div>
<div style="position:absolute;top:20910;left:166"><nobr>init by actions here</nobr></div>
<div style="position:absolute;top:20930;left:166"><nobr>extern void MyJogOn( short axis, short dir, double speed);    </nobr></div>
<div style="position:absolute;top:20930;left:610"><nobr>//Routines to start</nobr></div>
<div style="position:absolute;top:20950;left:166"><nobr>and stop Jogging..</nobr></div>
<div style="position:absolute;top:20969;left:166"><nobr>extern void MyJogOff(short axis);</nobr></div>
<div style="position:absolute;top:20988;left:166"><nobr>extern void myDwell( double time);</nobr></div>
<div style="position:absolute;top:21008;left:166"><nobr>extern void myProbe( );</nobr></div>
<div style="position:absolute;top:21027;left:166"><nobr>extern void myHome( short axis );</nobr></div>
<div style="position:absolute;top:21047;left:166"><nobr>extern void myPurge( short flags );    </nobr></div>
<div style="position:absolute;top:21047;left:535"><nobr>//for purging the G100</nobr></div>
<div style="position:absolute;top:21066;left:166"><nobr>extern void myReset();</nobr></div>
<div style="position:absolute;top:21105;left:166"><nobr>Just remember these are only references to allow the MachDevice interface to do its</nobr></div>
<div style="position:absolute;top:21125;left:166"><nobr>job outside of this file. In actual fact a plugin could be all done within</nobr></div>
<div style="position:absolute;top:21144;left:166"><nobr>MachDevice.cpp , the reason we call out to another file is just to keep things cleaner,</nobr></div>
<div style="position:absolute;top:21164;left:166"><nobr>and allow for a standard interface class of MachDevice.cpp.</nobr></div>
<div style="position:absolute;top:21183;left:166"><nobr>Next we define a few variables that some plugins use. </nobr></div>
<div style="position:absolute;top:21203;left:166"><nobr>CXMLProfile     *DevProf;</nobr></div>
<div style="position:absolute;top:21222;left:166"><nobr>OneShort    </nobr></div>
<div style="position:absolute;top:21222;left:277"><nobr>DoButton;     // void DoButton( code )</nobr></div>
<div style="position:absolute;top:21242;left:166"><nobr>DoubleShort     GetDRO;     // Double GetDRO( code )</nobr></div>
<div style="position:absolute;top:21261;left:166"><nobr>VoidShortDouble    SetDRO;     // void   SetDRO( short code, double value);</nobr></div>
<div style="position:absolute;top:21281;left:166"><nobr>BoolShort    </nobr></div>
<div style="position:absolute;top:21281;left:278"><nobr>GetLED;     // bool   GetLED( short code );</nobr></div>
<div style="position:absolute;top:21300;left:166"><nobr>VoidShortBool     SetLED;     //SetLED Fucntion</nobr></div>
<div style="position:absolute;top:21320;left:166"><nobr>CSTRret    </nobr></div>
<div style="position:absolute;top:21320;left:277"><nobr>GetProName;   // CString GetProName()</nobr></div>
<div style="position:absolute;top:21339;left:166"><nobr>VoidLPCSTR     Code;     // void    Code( "G0X10Y10" );</nobr></div>
<div style="position:absolute;top:21359;left:166"><nobr>IntShort    </nobr></div>
<div style="position:absolute;top:21359;left:268"><nobr>GetMenuRange;</nobr></div>
<div style="position:absolute;top:21378;left:174"><nobr>The first one, DevProf , is a pointer to a XML processor. Mach3 controls an XML</nobr></div>
<div style="position:absolute;top:21397;left:166"><nobr>processor to give access to system variables. When it has control it is exclusive </nobr></div>
</span></font>

<div style="position:absolute;top:21559;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="19"><b>Page 19</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:21613;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:21612;left:732"><nobr>18</nobr></div>
<div style="position:absolute;top:21690;left:166"><nobr>control, but at specific times in the life of a plugin, Mach3 will relinquish control of</nobr></div>
<div style="position:absolute;top:21709;left:166"><nobr>the XML , and allow the plugin to modify system variables. You MUST only use this</nobr></div>
<div style="position:absolute;top:21729;left:166"><nobr>variable when Mach3 has given up control of it though. Ill note that in the routines we</nobr></div>
<div style="position:absolute;top:21748;left:166"><nobr>discuss when that occurs.  The rest of the declarations we see are derived form the h</nobr></div>
<div style="position:absolute;top:21767;left:166"><nobr>files typing of certain pointer types. For example, DoButton is defined above as begin</nobr></div>
<div style="position:absolute;top:21787;left:166"><nobr>of type OnShort , which basically just translates to a declaration of </nobr></div>
<div style="position:absolute;top:21806;left:166"><nobr>Void DoButton( short var ) ; </nobr></div>
<div style="position:absolute;top:21826;left:174"><nobr>As you can see it isn’t as mysterious as it looks on first glance. Its just that Mach3</nobr></div>
<div style="position:absolute;top:21845;left:166"><nobr>has to see them defined this way to be able to call the routines in the plug-in. Next we</nobr></div>
<div style="position:absolute;top:21865;left:166"><nobr>see…</nobr></div>
<div style="position:absolute;top:21884;left:166"><nobr>HANDLE m_timerHandle;</nobr></div>
<div style="position:absolute;top:21904;left:166"><nobr>bool  KickTimer = false; //this will be a special case variable. See Update loop;</nobr></div>
<div style="position:absolute;top:21923;left:166"><nobr>bool  TimerOn = false;   // this tells us the timer is not yet running. (See Update Loop</nobr></div>
<div style="position:absolute;top:21943;left:166"><nobr>);</nobr></div>
<div style="position:absolute;top:21962;left:166"><nobr>// CXMLProfile</nobr></div>
<div style="position:absolute;top:21982;left:166"><nobr>CXMLProfile *AppProf;</nobr></div>
<div style="position:absolute;top:22001;left:166"><nobr>CString ProfileName;</nobr></div>
<div style="position:absolute;top:22040;left:170"><nobr>These are variables used in the for handling timers and the Profile name to be</nobr></div>
<div style="position:absolute;top:22060;left:166"><nobr>returned back to Mach3 to be displayed as a version number and plugin name.  Now</nobr></div>
<div style="position:absolute;top:22079;left:166"><nobr>we come to more important matters.</nobr></div>
<div style="position:absolute;top:22098;left:166"><nobr>TrajectoryControl *MainPlanner; //used for most planner functions and program</nobr></div>
<div style="position:absolute;top:22118;left:166"><nobr>control </nobr></div>
<div style="position:absolute;top:22138;left:166"><nobr>CMach4View     *MachView;    //used for most framework and configuration calls. </nobr></div>
<div style="position:absolute;top:22157;left:166"><nobr>TrajBuffer     *Engine;     //Ring0 memory for printer port control and other device</nobr></div>
<div style="position:absolute;top:22176;left:166"><nobr>synchronization</nobr></div>
<div style="position:absolute;top:22196;left:166"><nobr>setup    </nobr></div>
<div style="position:absolute;top:22196;left:257"><nobr>*_setup;     //Trajectory planners setup block. Always in effect</nobr></div>
<div style="position:absolute;top:22215;left:166"><nobr>These variables are pointers to Mach3's main blocks which we've been discussing in</nobr></div>
<div style="position:absolute;top:22235;left:166"><nobr>this document. MainPlanner is the App in our discussions, or most of the App.</nobr></div>
<div style="position:absolute;top:22254;left:166"><nobr>MachView is also part of the App, but is not required as much by a  plugin writer.</nobr></div>
<div style="position:absolute;top:22274;left:166"><nobr>Engine is the "Shared Memory Block" we have been discussing. _setup is the one you</nobr></div>
<div style="position:absolute;top:22293;left:166"><nobr>haven’t heard of till now, and it’s the planner variable block. The main Gcode</nobr></div>
<div style="position:absolute;top:22313;left:166"><nobr>processors variables. It can give you access to Gcode variables, states, modes, and</nobr></div>
<div style="position:absolute;top:22332;left:166"><nobr>errors. </nobr></div>
<div style="position:absolute;top:22352;left:166"><nobr>These variables are filled automatically during load to set them to point to Mach3. So</nobr></div>
<div style="position:absolute;top:22371;left:166"><nobr>for example is the coder wants access to the FeedRate variable in Mach3, he'd use</nobr></div>
<div style="position:absolute;top:22391;left:166"><nobr>MainPlanner-&gt;FeedRate. If he wants a signal level he'd use Engine-</nobr></div>
<div style="position:absolute;top:22410;left:166"><nobr>&gt;InSigs[INPUT1].Activated . In this way the plugin author can get access to almost</nobr></div>
<div style="position:absolute;top:22430;left:166"><nobr>any system variable. These variable then, are your hook into the logic of Mach3. </nobr></div>
<div style="position:absolute;top:22449;left:166"><nobr>#include " ServoRun.h"     // add includes for code you call here</nobr></div>
<div style="position:absolute;top:22469;left:166"><nobr>extern ServoRun *sr;</nobr></div>
<div style="position:absolute;top:22488;left:174"><nobr>These are our mythical device class declarations. If your device is called</nobr></div>
<div style="position:absolute;top:22508;left:166"><nobr>"MyDoorOpener", you'd write a class that knows how to control your door opener and</nobr></div>
<div style="position:absolute;top:22527;left:166"><nobr>declare that class and an pointer to it to be used. You'll notice the pointer to the device</nobr></div>
<div style="position:absolute;top:22547;left:166"><nobr>"sr" is external , this is because its expected to be created in the</nobr></div>
<div style="position:absolute;top:22566;left:166"><nobr>MachDevImplementations. Doesn’t have to be, but often is.. </nobr></div>
<div style="position:absolute;top:22585;left:166"><nobr>CMachDeviceApp::CMachDeviceApp() </nobr></div>
</span></font>

<div style="position:absolute;top:22747;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="20"><b>Page 20</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:22801;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:22800;left:732"><nobr>19</nobr></div>
<div style="position:absolute;top:22878;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:22897;left:183"><nobr>// TODO: add construction code here,</nobr></div>
<div style="position:absolute;top:22917;left:183"><nobr>// Place all significant initialization in InitInstance</nobr></div>
<div style="position:absolute;top:22936;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:22975;left:166"><nobr>CMachDeviceApp::~CMachDeviceApp()</nobr></div>
<div style="position:absolute;top:22994;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:23033;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:23053;left:174"><nobr>As you'll notice the constructor and destructor are empty. They aren’t used by the</nobr></div>
<div style="position:absolute;top:23072;left:166"><nobr>system at all, but you are free to use them if required. I make no pretence that the</nobr></div>
<div style="position:absolute;top:23092;left:166"><nobr>structure I used was the best to use, I was learning as I went so today Id probably do it</nobr></div>
<div style="position:absolute;top:23111;left:166"><nobr>somewhat differently , but this format does work well. </nobr></div>
<div style="position:absolute;top:23131;left:166"><nobr>CMachDeviceApp theApp; </nobr></div>
<div style="position:absolute;top:23150;left:166"><nobr>Is used by the system to control the application object, this is just a declaration you</nobr></div>
<div style="position:absolute;top:23170;left:166"><nobr>wont use personally.</nobr></div>
<div style="position:absolute;top:23189;left:166"><nobr>BOOL CMachDeviceApp::InitInstance()</nobr></div>
<div style="position:absolute;top:23209;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:23228;left:183"><nobr>CWinApp::InitInstance();</nobr></div>
<div style="position:absolute;top:23267;left:183"><nobr>if (!AfxSocketInit())</nobr></div>
<div style="position:absolute;top:23286;left:183"><nobr>{</nobr></div>
<div style="position:absolute;top:23306;left:200"><nobr>AfxMessageBox("Sockets Init Failed");</nobr></div>
<div style="position:absolute;top:23326;left:200"><nobr>return FALSE;</nobr></div>
<div style="position:absolute;top:23345;left:183"><nobr>}</nobr></div>
<div style="position:absolute;top:23384;left:183"><nobr>// Register all OLE server (factories) as running.  This enables the</nobr></div>
<div style="position:absolute;top:23403;left:183"><nobr>//  OLE libraries to create objects from other applications.</nobr></div>
<div style="position:absolute;top:23423;left:183"><nobr>COleObjectFactory::RegisterAll();</nobr></div>
<div style="position:absolute;top:23462;left:183"><nobr>return TRUE;</nobr></div>
<div style="position:absolute;top:23481;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:23520;left:174"><nobr>Heres our first routine, and it’s a simple one. Its called as the plugin is loaded, before</nobr></div>
<div style="position:absolute;top:23540;left:166"><nobr>Mach3 is actually running full out, so you wont interface to mach3 here, you'll just</nobr></div>
<div style="position:absolute;top:23559;left:166"><nobr>use this to tell the system you intend to use Sockets in this case, if you don’t know</nobr></div>
<div style="position:absolute;top:23579;left:166"><nobr>what Sockets are then you probably need not worry about it. If you do know then no</nobr></div>
<div style="position:absolute;top:23598;left:166"><nobr>further explanation is required. </nobr></div>
<div style="position:absolute;top:23618;left:166"><nobr>// DllGetClassObject - Returns class factory</nobr></div>
<div style="position:absolute;top:23657;left:166"><nobr>STDAPI DllGetClassObject(REFCLSID rclsid, REFIID riid, LPVOID* ppv)</nobr></div>
<div style="position:absolute;top:23676;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:23696;left:183"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState());</nobr></div>
<div style="position:absolute;top:23715;left:183"><nobr>return AfxDllGetClassObject(rclsid, riid, ppv);</nobr></div>
<div style="position:absolute;top:23735;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:23773;left:166"><nobr>// DllCanUnloadNow - Allows COM to unload DLL </nobr></div>
</span></font>

<div style="position:absolute;top:23935;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="21"><b>Page 21</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:23989;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:23988;left:732"><nobr>20</nobr></div>
<div style="position:absolute;top:24085;left:166"><nobr>STDAPI DllCanUnloadNow(void)</nobr></div>
<div style="position:absolute;top:24105;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:24124;left:183"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState());</nobr></div>
<div style="position:absolute;top:24143;left:183"><nobr>return AfxDllCanUnloadNow();</nobr></div>
<div style="position:absolute;top:24163;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:24202;left:166"><nobr>// DllRegisterServer - Adds entries to the system registry</nobr></div>
<div style="position:absolute;top:24241;left:166"><nobr>STDAPI DllRegisterServer(void)</nobr></div>
<div style="position:absolute;top:24260;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:24280;left:183"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState());</nobr></div>
<div style="position:absolute;top:24319;left:183"><nobr>if (!AfxOleRegisterTypeLib(AfxGetInstanceHandle(), _tlid))</nobr></div>
<div style="position:absolute;top:24338;left:200"><nobr>return SELFREG_E_TYPELIB;</nobr></div>
<div style="position:absolute;top:24377;left:183"><nobr>if (!COleObjectFactory::UpdateRegistryAll())</nobr></div>
<div style="position:absolute;top:24397;left:200"><nobr>return SELFREG_E_CLASS;</nobr></div>
<div style="position:absolute;top:24436;left:183"><nobr>return S_OK;</nobr></div>
<div style="position:absolute;top:24455;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:24494;left:166"><nobr>// DllUnregisterServer - Removes entries from the system registry</nobr></div>
<div style="position:absolute;top:24533;left:166"><nobr>STDAPI DllUnregisterServer(void)</nobr></div>
<div style="position:absolute;top:24552;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:24572;left:183"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState());</nobr></div>
<div style="position:absolute;top:24611;left:183"><nobr>if (!AfxOleUnregisterTypeLib(_tlid, _wVerMajor, _wVerMinor))</nobr></div>
<div style="position:absolute;top:24630;left:200"><nobr>return SELFREG_E_TYPELIB;</nobr></div>
<div style="position:absolute;top:24669;left:183"><nobr>if (!COleObjectFactory::UpdateRegistryAll(FALSE))</nobr></div>
<div style="position:absolute;top:24689;left:200"><nobr>return SELFREG_E_CLASS;</nobr></div>
<div style="position:absolute;top:24747;left:183"><nobr>return S_OK;</nobr></div>
<div style="position:absolute;top:24767;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:24786;left:174"><nobr>The above are all boilerplate, you neednt worry about them, they are used by the</nobr></div>
<div style="position:absolute;top:24806;left:166"><nobr>system only to allow some DLL functions to operate. Leave them alone for the most</nobr></div>
<div style="position:absolute;top:24825;left:166"><nobr>part unless you have a deeper understanding of what they are doing. </nobr></div>
<div style="position:absolute;top:24845;left:166"><nobr>extern "C" __declspec(dllexport) void Notify( int ID )    </nobr></div>
<div style="position:absolute;top:24845;left:575"><nobr>//void DoButton( short</nobr></div>
<div style="position:absolute;top:24864;left:166"><nobr>code );</nobr></div>
<div style="position:absolute;top:24884;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:24903;left:183"><nobr>//here ID is the menu item just clicked..</nobr></div>
<div style="position:absolute;top:24923;left:183"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
<div style="position:absolute;top:24942;left:183"><nobr>myNotify( ID ); </nobr></div>
</span></font>

<div style="position:absolute;top:25123;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="22"><b>Page 22</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:25177;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:25176;left:732"><nobr>21</nobr></div>
<div style="position:absolute;top:25254;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:25273;left:179"><nobr>Heres out first declaration of importance. And its best if you understand exactly</nobr></div>
<div style="position:absolute;top:25293;left:166"><nobr>what's going on here so Ill explain this one in depth, most of the following work the</nobr></div>
<div style="position:absolute;top:25312;left:166"><nobr>same way in terms of how they are declared. You'll notice its declared as extern "C"</nobr></div>
<div style="position:absolute;top:25331;left:166"><nobr>__declspec , this is so that Mach3 can find it. During startup of a plugin, Mach3 looks</nobr></div>
<div style="position:absolute;top:25351;left:166"><nobr>for specific routines, basically all the ones with extern, if it find one it expects, it adds</nobr></div>
<div style="position:absolute;top:25370;left:166"><nobr>it to a list of calls that Mach3 will make. For example, if the routine Notify is not in</nobr></div>
<div style="position:absolute;top:25390;left:166"><nobr>the machdevice, mach3 will not trip an error, it just wont try to use it in the course of</nobr></div>
<div style="position:absolute;top:25409;left:166"><nobr>running the program. In this way some plugins can be shrunk down just by removing</nobr></div>
<div style="position:absolute;top:25429;left:166"><nobr>functions unused. But since the call mechanism is very fast, you really don’t save</nobr></div>
<div style="position:absolute;top:25448;left:166"><nobr>much time by removing these functions, just leave their implementation blank if you</nobr></div>
<div style="position:absolute;top:25468;left:166"><nobr>don’t use them. The Notify routine is called by Mach3 in the case of certain events</nobr></div>
<div style="position:absolute;top:25487;left:166"><nobr>happening. There is a list of define in the TrajectoryControl file that dictate what</nobr></div>
<div style="position:absolute;top:25507;left:166"><nobr>events can be used.  They are </nobr></div>
<div style="position:absolute;top:25526;left:166"><nobr>//Plugin Notifications and defines..</nobr></div>
<div style="position:absolute;top:25546;left:166"><nobr>enum { EX_DDA , EX_VMS, EX_COMMAND, EX_SPINON, EX_SPINOFF,</nobr></div>
<div style="position:absolute;top:25565;left:166"><nobr>EX_SPINSPEED, EX_MOTORTUNED </nobr></div>
<div style="position:absolute;top:25585;left:195"><nobr>, EX_SETUP, EX_FEEDHOLD, EX_RUN, EX_ESTOP ,EX_CONFIG,</nobr></div>
<div style="position:absolute;top:25604;left:166"><nobr>EX_REWIND , EX_RESET };</nobr></div>
<div style="position:absolute;top:25624;left:170"><nobr>These ID's tell the plugin what has occurred. If MyNotify is called with ID = 3, then</nobr></div>
<div style="position:absolute;top:25643;left:166"><nobr>the user has commanded the spindle to turn on. ( EX_SPINON = 3) , and if the user</nobr></div>
<div style="position:absolute;top:25662;left:166"><nobr>turns off the spindle, then ID will be equal to EX_SPINOFF. More notifications will</nobr></div>
<div style="position:absolute;top:25682;left:166"><nobr>likely get added over time, but the list includes most things the plugin should know</nobr></div>
<div style="position:absolute;top:25702;left:166"><nobr>about. The code we're on though is just a header declaration to tell mach3 that such a</nobr></div>
<div style="position:absolute;top:25721;left:166"><nobr>call does exist. More such declarations follow in the machdevice.cpp file. As you can</nobr></div>
<div style="position:absolute;top:25740;left:166"><nobr>see the code just calls MyNotify(ID) which means its simply passing the call to the</nobr></div>
<div style="position:absolute;top:25760;left:166"><nobr>MachDeviceImplementation.cpp file for processing. As mentioned before you don’t</nobr></div>
<div style="position:absolute;top:25779;left:166"><nobr>really need to pass the call on, but to keep things clean and allow you to start a plugin</nobr></div>
<div style="position:absolute;top:25799;left:166"><nobr>easily, its usually best to keep the machdevice.cpp as generic as possible. A typical</nobr></div>
<div style="position:absolute;top:25818;left:166"><nobr>MyNotify function for the ServoRun object may look like this..</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:25856;left:166"><nobr>void <font color="#000000">myNotify(</font>int <font color="#000000">message)</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:25869;left:166"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:25881;left:193"><nobr>if<font color="#000000">( sr == NULL ) </font>return<font color="#000000">; //return if there is no sr object</font></nobr></div>
<div style="position:absolute;top:25907;left:193"><nobr>if<font color="#000000">( Engine-&gt;EStop &amp;&amp; sr-&gt;curSEQ != SNOSEQ ) //if we are in EStop, kill all motion</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:25920;left:227"><nobr>{</nobr></div>
<div style="position:absolute;top:25933;left:247"><nobr>sr-&gt;StopAllMotion();</nobr></div>
<div style="position:absolute;top:25946;left:247"><nobr>sr-&gt;curSEQ = SSTOPSEQ; <font color="#008000">//just in case;</font></nobr></div>
<div style="position:absolute;top:25958;left:247"><nobr>Engine-&gt;DwellTime = 0;</nobr></div>
<div style="position:absolute;top:25971;left:227"><nobr>}</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:25997;left:193"><nobr>if<font color="#000000">( message == 0xffff ) </font><font color="#008000">//unsigned message, so check in hex..</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:26009;left:193"><nobr>{</nobr></div>
<div style="position:absolute;top:26022;left:220"><nobr>//General Stop command called    </nobr></div>
<div style="position:absolute;top:26035;left:220"><nobr>Engine-&gt;DwellTime = 0; //stop any dwell in progress..</nobr></div>
<div style="position:absolute;top:26048;left:220"><nobr>Engine-&gt;State = STOP; //stop any ring buffer calcs in Mach3.</nobr></div>
<div style="position:absolute;top:26061;left:220"><nobr>MainPlanner-&gt;SoftWait = 0; //stop any waiting in Mach3.</nobr></div>
<div style="position:absolute;top:26074;left:220"><nobr>sr-&gt;StopAnyJogging();  <font color="#008000">//to kill the Jog processor..</font></nobr></div>
<div style="position:absolute;top:26087;left:193"><nobr>}</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:26112;left:193"><nobr>if<font color="#000000">( message == EX_CONFIG )</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:26125;left:193"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:26138;left:220"><nobr>if<font color="#000000">( sr != NULL )</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:26150;left:234"><nobr>{</nobr></div>
<div style="position:absolute;top:26163;left:254"><nobr>sr-&gt;Initialize(); //reinit the device, the user has just reconfigured. </nobr></div>
</span></font>

<div style="position:absolute;top:26311;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="23"><b>Page 23</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:26365;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:26364;left:732"><nobr>22</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:26440;left:261"><nobr>Engine-&gt;DwellTime = 0;</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:26453;left:261"><nobr>return<font color="#000000">;</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:26466;left:193"><nobr>}</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:26491;left:173"><nobr>if<font color="#000000">( message == EX_MOTORTUNED )</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:26504;left:173"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:26517;left:227"><nobr>if<font color="#000000">( sr != NULL )</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:26530;left:227"><nobr>{</nobr></div>
<div style="position:absolute;top:26543;left:240"><nobr>sr-&gt;Initialize();</nobr></div>
<div style="position:absolute;top:26555;left:240"><nobr>Engine-&gt;DwellTime = 0;</nobr></div>
<div style="position:absolute;top:26568;left:227"><nobr>}</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:26581;left:227"><nobr>return<font color="#000000">;</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:26594;left:173"><nobr>}</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:26619;left:173"><nobr>if<font color="#000000">( message == EX_SPINON || message == EX_SPINSPEED ) </font><font color="#008000">//this is Spindle ON;..</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:26632;left:193"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:26645;left:220"><nobr>if<font color="#000000">( sr != NULL  &amp;&amp; Engine-&gt;Axis[6].Jogging ) </font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:26658;left:220"><nobr>{</nobr></div>
<div style="position:absolute;top:26671;left:240"><nobr>sr-&gt;SetSpindle( MainPlanner-&gt;Spindle.ratio);</nobr></div>
<div style="position:absolute;top:26683;left:220"><nobr>}</nobr></div>
<div style="position:absolute;top:26696;left:220"><nobr>return;</nobr></div>
<div style="position:absolute;top:26709;left:193"><nobr>}</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:26722;left:166"><nobr>if<font color="#000000">( message == EX_SPINOFF ) </font><font color="#008000">//this is Spindle OFF;..</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:26735;left:186"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:26747;left:193"><nobr>if<font color="#000000">( sr != NULL  )  </font><font color="#008000">//meaning the ServoRun is running</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:26760;left:227"><nobr>{</nobr></div>
<div style="position:absolute;top:26773;left:240"><nobr>sr-&gt;SetSpindleOff(0);</nobr></div>
<div style="position:absolute;top:26786;left:227"><nobr>}</nobr></div>
<div style="position:absolute;top:26811;left:186"><nobr>}</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:26837;left:173"><nobr>}</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:26883;left:166"><nobr>You may have more messages you wish to process, the point is here is where you will</nobr></div>
<div style="position:absolute;top:26903;left:166"><nobr>notify the sr device to take appropriate action for whatever notification is incoming</nobr></div>
<div style="position:absolute;top:26922;left:166"><nobr>from mach3. You'll see in the general update function where you can do more</nobr></div>
<div style="position:absolute;top:26942;left:166"><nobr>asynchronous types of processing.  </nobr></div>
<div style="position:absolute;top:26981;left:170"><nobr>Next we see a few more rather small entries..</nobr></div>
<div style="position:absolute;top:27020;left:166"><nobr>extern "C" __declspec(dllexport) void SetDoButton(OneShort pFunc)    </nobr></div>
<div style="position:absolute;top:27020;left:682"><nobr>//void</nobr></div>
<div style="position:absolute;top:27039;left:166"><nobr>DoButton( short code );</nobr></div>
<div style="position:absolute;top:27059;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:27078;left:183"><nobr>DoButton = pFunc; </nobr></div>
<div style="position:absolute;top:27098;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:27137;left:166"><nobr>extern "C" __declspec(dllexport) void SetGetMenuRange(IntShort pFunc)     //void</nobr></div>
<div style="position:absolute;top:27156;left:166"><nobr>DoButton( short code );</nobr></div>
<div style="position:absolute;top:27176;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:27195;left:183"><nobr>GetMenuRange = pFunc; </nobr></div>
<div style="position:absolute;top:27215;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:27254;left:166"><nobr>extern "C" __declspec(dllexport) void SetSetDRO(VoidShortDouble pFunc)   //void</nobr></div>
<div style="position:absolute;top:27273;left:166"><nobr>SetDRO( short code, double value );</nobr></div>
<div style="position:absolute;top:27292;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:27312;left:183"><nobr>SetDRO = pFunc; </nobr></div>
<div style="position:absolute;top:27331;left:166"><nobr>} </nobr></div>
</span></font>

<div style="position:absolute;top:27499;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="24"><b>Page 24</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:27553;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:27552;left:732"><nobr>23</nobr></div>
<div style="position:absolute;top:27630;left:166"><nobr>extern "C" __declspec(dllexport) void SetGetDRO(DoubleShort pFunc)     // double</nobr></div>
<div style="position:absolute;top:27649;left:166"><nobr>GetDRO( short code );</nobr></div>
<div style="position:absolute;top:27669;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:27688;left:183"><nobr>GetDRO = pFunc; </nobr></div>
<div style="position:absolute;top:27707;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:27746;left:166"><nobr>extern "C" __declspec(dllexport) void SetGetLED(BoolShort pFunc)    </nobr></div>
<div style="position:absolute;top:27746;left:682"><nobr>// bool </nobr></div>
<div style="position:absolute;top:27766;left:166"><nobr>GetLED( short code );  </nobr></div>
<div style="position:absolute;top:27785;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:27805;left:183"><nobr>GetLED = pFunc; </nobr></div>
<div style="position:absolute;top:27824;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:27863;left:166"><nobr>extern "C" __declspec(dllexport) void SetSetLED(VoidShortBool pFunc)    </nobr></div>
<div style="position:absolute;top:27863;left:713"><nobr>//</nobr></div>
<div style="position:absolute;top:27883;left:166"><nobr>bool  GetLED( short code );  </nobr></div>
<div style="position:absolute;top:27902;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:27922;left:183"><nobr>SetLED = pFunc; </nobr></div>
<div style="position:absolute;top:27941;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:27980;left:166"><nobr>extern "C" __declspec(dllexport) void SetCode(VoidLPCSTR pFunc)    </nobr></div>
<div style="position:absolute;top:27980;left:686"><nobr>// bool </nobr></div>
<div style="position:absolute;top:28000;left:166"><nobr>GetLED( short code );  </nobr></div>
<div style="position:absolute;top:28019;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:28038;left:183"><nobr>Code = pFunc; </nobr></div>
<div style="position:absolute;top:28058;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:28078;left:166"><nobr>These retrieve from Mach3 the addresses of the Mach3 functions used to do calls like</nobr></div>
<div style="position:absolute;top:28097;left:166"><nobr>SetLED() , they are only used by the plugin as it starts up as when Mach3 see's them,</nobr></div>
<div style="position:absolute;top:28116;left:166"><nobr>it calls them, passing the addresses of the actual Mach3 functions. SO one the call sets</nobr></div>
<div style="position:absolute;top:28136;left:166"><nobr>SetLed = pFunc , the plugin may from then on call SetLed( 100, true) for example. As</nobr></div>
<div style="position:absolute;top:28155;left:166"><nobr>I say, this is done all automatically, so all you need to know is that the plugin may use</nobr></div>
<div style="position:absolute;top:28175;left:166"><nobr>Mach3 functions of those names. SetLed(led,state) Code("text"), DoButton(button)</nobr></div>
<div style="position:absolute;top:28194;left:166"><nobr>etc..</nobr></div>
<div style="position:absolute;top:28233;left:170"><nobr>Next we can see </nobr></div>
<div style="position:absolute;top:28253;left:166"><nobr>extern "C" __declspec(dllexport) char* SetProName( CString name)    </nobr></div>
<div style="position:absolute;top:28253;left:677"><nobr>// CString </nobr></div>
<div style="position:absolute;top:28272;left:166"><nobr>GetProfName();  </nobr></div>
<div style="position:absolute;top:28292;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:28311;left:183"><nobr>static CString strPlgName, strVer;</nobr></div>
<div style="position:absolute;top:28331;left:183"><nobr>ProfileName =   name;</nobr></div>
<div style="position:absolute;top:28350;left:183"><nobr>DevProf = new  CXMLProfile(); //start up the Profile class for XML usage.</nobr></div>
<div style="position:absolute;top:28370;left:183"><nobr>strVer = myProfileInit (name, DevProf); // call implementers code</nobr></div>
<div style="position:absolute;top:28389;left:183"><nobr>strPlgName = AfxGetApp()-&gt;m_pszExeName + strVer;</nobr></div>
<div style="position:absolute;top:28409;left:183"><nobr>delete DevProf;</nobr></div>
<div style="position:absolute;top:28428;left:183"><nobr>return (char*)(LPCTSTR)strPlgName;</nobr></div>
<div style="position:absolute;top:28448;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:28487;left:179"><nobr>This is used to open the Mach3 current XML. Mach3 calls this routine at startup of</nobr></div>
<div style="position:absolute;top:28506;left:166"><nobr>the plugin to give the plugin the opportunity to get data from Mach3's current XML. </nobr></div>
</span></font>

<div style="position:absolute;top:28687;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="25"><b>Page 25</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:28741;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:28740;left:732"><nobr>24</nobr></div>
<div style="position:absolute;top:28818;left:166"><nobr>You'll notice it calls myProfileInit() . This is usually where the actual work is done. A</nobr></div>
<div style="position:absolute;top:28837;left:166"><nobr>typical myProfileInit would look like.</nobr></div>
<div style="position:absolute;top:28876;left:166"><nobr>CString DefDir; </nobr></div>
<div style="position:absolute;top:28895;left:166"><nobr>void myProfileInit(CString name, CXMLProfile *DevPro)</nobr></div>
<div style="position:absolute;top:28915;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:28954;left:170"><nobr>CString s;</nobr></div>
<div style="position:absolute;top:28973;left:170"><nobr>//this gets the default directory DefDir in which Mach3 is located.  And the profile    </nobr></div>
<div style="position:absolute;top:28993;left:166"><nobr>//name ex. "Mach3Mill"</nobr></div>
<div style="position:absolute;top:29012;left:170"><nobr>DefDir = DevProf-&gt;GetProfileString("Preferences","DefDir","C:\\Mach3\\");</nobr></div>
<div style="position:absolute;top:29032;left:170"><nobr>Profile = DevProf-&gt;GetProfileString("Preferences","Profile","Mach3Mill");</nobr></div>
<div style="position:absolute;top:29051;left:170"><nobr>// The values stored in the XML file should represent text of the actual quantity    </nobr></div>
<div style="position:absolute;top:29071;left:166"><nobr>involved.</nobr></div>
<div style="position:absolute;top:29090;left:170"><nobr>ControllerFreq = DevProf-&gt;GetProfileString(MyDeviceName, "ControllerFreq", "");   </nobr></div>
<div style="position:absolute;top:29110;left:170"><nobr>return "Version 1.0";</nobr></div>
<div style="position:absolute;top:29129;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:29168;left:179"><nobr>In this variation, if the plugin is named " ServoRun.dll" then the SetProName will</nobr></div>
<div style="position:absolute;top:29188;left:166"><nobr>return the string ServoRun Version 1.0" to Mach3 as the plugins official name and the</nobr></div>
<div style="position:absolute;top:29207;left:166"><nobr>name that appears in the device selection dialog in Mach3 to select this device. </nobr></div>
<div style="position:absolute;top:29246;left:170"><nobr>Next in the code of  MachDevice.cpp we see :</nobr></div>
<div style="position:absolute;top:29285;left:179"><nobr>extern "C" __declspec(dllexport) void StopPlug(void</nobr></div>
<div style="position:absolute;top:29304;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:29324;left:183"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
<div style="position:absolute;top:29343;left:174"><nobr>DevProf = new  CXMLProfile(); //start up the Profile class for XML usage.    </nobr></div>
<div style="position:absolute;top:29363;left:174"><nobr>myCleanUp(); </nobr></div>
<div style="position:absolute;top:29382;left:174"><nobr>delete DevProf;</nobr></div>
<div style="position:absolute;top:29402;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:29421;left:179"><nobr>Since the plugin has opened a profile before, during the init, it can now open a</nobr></div>
<div style="position:absolute;top:29441;left:166"><nobr>profile in this routine</nobr></div>
<div style="position:absolute;top:29460;left:166"><nobr>with just a DevProf = new CXMLProfile(); This is because it already knows the name</nobr></div>
<div style="position:absolute;top:29480;left:166"><nobr>of the profile. This routine is used to close the plugin. The function myCleanup()</nobr></div>
<div style="position:absolute;top:29499;left:166"><nobr>should be used to delete any variables you created from the heap, or any classes you</nobr></div>
<div style="position:absolute;top:29519;left:166"><nobr>made. Typically , since you would have created a class object for whatever device</nobr></div>
<div style="position:absolute;top:29538;left:166"><nobr>your using, you'd delete that device in myCleanup as in this one for the ServoRun.</nobr></div>
<div style="position:absolute;top:29577;left:166"><nobr>void myCleanUp() //used for destruction of variables prior to exit..  Called as MAch3</nobr></div>
<div style="position:absolute;top:29597;left:166"><nobr>shuts down. </nobr></div>
<div style="position:absolute;top:29616;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:29655;left:183"><nobr>sr-&gt;ShutDown = true;</nobr></div>
<div style="position:absolute;top:29694;left:183"><nobr>if( sr != NULL )</nobr></div>
<div style="position:absolute;top:29713;left:183"><nobr>{ </nobr></div>
</span></font>

<div style="position:absolute;top:29875;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="26"><b>Page 26</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:29929;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:29928;left:732"><nobr>25</nobr></div>
<div style="position:absolute;top:30006;left:200"><nobr>myReset();</nobr></div>
<div style="position:absolute;top:30064;left:200"><nobr>DevProf-&gt;WriteProfileString(MyDeviceName, "Variable0",Vars[0]);</nobr></div>
<div style="position:absolute;top:30083;left:200"><nobr>DevProf-&gt;WriteProfileString(MyDeviceName, "Variable1",Vars[1]);</nobr></div>
<div style="position:absolute;top:30103;left:200"><nobr>…etc…</nobr></div>
<div style="position:absolute;top:30122;left:200"><nobr>delete sr;</nobr></div>
<div style="position:absolute;top:30142;left:200"><nobr>sr = NULL;</nobr></div>
<div style="position:absolute;top:30161;left:183"><nobr>}</nobr></div>
<div style="position:absolute;top:30200;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:30220;left:174"><nobr>Here we are simply deleting the ServoRun object "sr" after setting it to shutdown, a</nobr></div>
<div style="position:absolute;top:30239;left:166"><nobr>Boolean used perhaps in a timer routine. Then using myReset to set the device into a</nobr></div>
<div style="position:absolute;top:30259;left:166"><nobr>mode where its outputs would shut down, then deleting the sr object , setting it to</nobr></div>
<div style="position:absolute;top:30278;left:166"><nobr>NULL and returning. We also saved some variables </nobr></div>
<div style="position:absolute;top:30298;left:166"><nobr>That the mythical sr object may have used for internal parameters.  All of this of</nobr></div>
<div style="position:absolute;top:30317;left:166"><nobr>course , depends on your device or object your controlling.</nobr></div>
<div style="position:absolute;top:30356;left:174"><nobr>As you can see, the way the flow works is Mach3 calls the MAchDevice.cpp when it</nobr></div>
<div style="position:absolute;top:30376;left:166"><nobr>needs to, and the MachDevImplemention.cpp  holds the device specific routines that</nobr></div>
<div style="position:absolute;top:30395;left:166"><nobr>MachDevice.cpp sends to command up to. </nobr></div>
<div style="position:absolute;top:30414;left:166"><nobr>When Mach3 gets told to shutdown, this process then helps you shut it all down.. </nobr></div>
<div style="position:absolute;top:30454;left:166"><nobr>Next in the MachDevice we have:</nobr></div>
<div style="position:absolute;top:30492;left:166"><nobr>extern "C" __declspec(dllexport) void DoDwell(double time)    </nobr></div>
<div style="position:absolute;top:30492;left:629"><nobr>// bool  GetLED(</nobr></div>
<div style="position:absolute;top:30512;left:166"><nobr>short code );  </nobr></div>
<div style="position:absolute;top:30531;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:30551;left:183"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
<div style="position:absolute;top:30570;left:183"><nobr>myDwell(time); </nobr></div>
<div style="position:absolute;top:30590;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:30629;left:170"><nobr>This obviously gets called when Mach3 processes a G04 command. In this case the</nobr></div>
<div style="position:absolute;top:30648;left:166"><nobr>myDwell command would send a command to the ServoRun device and it would do a</nobr></div>
<div style="position:absolute;top:30668;left:166"><nobr>dwell process. Perhaps a routine such as this in the implementation file..</nobr></div>
<div style="position:absolute;top:30707;left:166"><nobr>void myDwell( double time)</nobr></div>
<div style="position:absolute;top:30726;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:30746;left:174"><nobr>if( sr == NULL ) return;</nobr></div>
<div style="position:absolute;top:30785;left:183"><nobr>Engine-&gt;DwellTime = (int) time * 1000;</nobr></div>
<div style="position:absolute;top:30804;left:183"><nobr>sr-&gt;DoADwell( time );</nobr></div>
<div style="position:absolute;top:30843;left:166"><nobr>}</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:30881;left:173"><nobr>The sr device in this case is sent a command to start timing a dwell. The Engine-&gt;DwellTime is set to</nobr></div>
<div style="position:absolute;top:30898;left:166"><nobr>the time required. Mach3 wont continue until Engine-&gt;DwellTime is zeroed. It’s the responsibility of </nobr></div>
</span></font>

<div style="position:absolute;top:31063;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="27"><b>Page 27</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:31117;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:31116;left:732"><nobr>26</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:31193;left:166"><nobr>the sr device object to clear the dwelltime variable once it senses the device has timed out on that</nobr></div>
<div style="position:absolute;top:31209;left:166"><nobr>dwell. </nobr></div>
<div style="position:absolute;top:31242;left:166"><nobr>The next function is only called if the plugin is a External motion engine and was selected for use in</nobr></div>
<div style="position:absolute;top:31258;left:166"><nobr>this profile. You can use it to create your device object in this case. You cannot use XML profiles at</nobr></div>
<div style="position:absolute;top:31274;left:166"><nobr>this point. </nobr></div>
</span></font>
<font size="3" color="#0000ff" face="Times"><span style="font-size:12px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:31310;left:166"><nobr>extern <font color="#000000">"C" </font>__declspec<font color="#000000">(</font>dllexport<font color="#000000">) </font>void <font color="#000000">PostInitControl()</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:31326;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:31342;left:200"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
</span></font>
<font size="3" color="#008000" face="Times"><span style="font-size:12px;font-family:Times;color:#008000">
<div style="position:absolute;top:31358;left:200"><nobr>//this routine is called after Mach3 has initialised. Use it as</nobr></div>
<div style="position:absolute;top:31374;left:166"><nobr>Init, BUT no usage of the XML files at all here. Only in  Init.</nobr></div>
<div style="position:absolute;top:31390;left:200"><nobr>//this routine is handy for changing variables that Mach3 has</nobr></div>
<div style="position:absolute;top:31406;left:166"><nobr>loaded at startup. Usually, Mach3 will permanently save any var's you</nobr></div>
<div style="position:absolute;top:31422;left:166"><nobr>change here..</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:31454;left:200"><nobr>myPostInitControl (); </nobr></div>
</span></font>
<font size="3" color="#0000ff" face="Times"><span style="font-size:12px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:31470;left:200"><nobr>return<font color="#000000">; </font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:31486;left:166"><nobr>}</nobr></div>
<div style="position:absolute;top:31502;left:183"><nobr>A typical myPostInitControl function would look like this..</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:31533;left:166"><nobr>void</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:31533;left:220"><nobr>myPostInitControl ()</nobr></div>
<div style="position:absolute;top:31546;left:166"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:31572;left:193"><nobr>// The user has selected the ServoRun as the motion device</nobr></div>
<div style="position:absolute;top:31585;left:193"><nobr>// Create an instance of the ServoRun Class</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:31597;left:193"><nobr>sr = <font color="#0000ff">new </font>CServoRun();</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:31610;left:193"><nobr>if <font color="#000000">(sr == NULL)</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:31623;left:193"><nobr>{</nobr></div>
<div style="position:absolute;top:31636;left:220"><nobr>AfxMessageBox("Unable to create ServoRun Class");</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:31649;left:220"><nobr>return<font color="#000000">;</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:31661;left:193"><nobr>}</nobr></div>
<div style="position:absolute;top:31687;left:193"><nobr>sr-&gt;Initialise();  <font color="#008000">// Init the device</font></nobr></div>
<div style="position:absolute;top:31713;left:166"><nobr>}</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:31739;left:179"><nobr>Here we have simply created a device object "sr" and initialized it. The details of</nobr></div>
<div style="position:absolute;top:31759;left:166"><nobr>your initialization and what to do if it fails is left to the plugin author of course.</nobr></div>
<div style="position:absolute;top:31798;left:166"><nobr>Next in the Device class we have the InitControl..</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:31836;left:166"><nobr>extern <font color="#000000">"C" </font>__declspec<font color="#000000">(</font>dllexport<font color="#000000">) </font>bool <font color="#000000">InitControl( </font>void <font color="#000000">*oEngine , </font>void <font color="#000000">*oSetup , </font>void</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:31848;left:166"><nobr>*oMainPlanner, <font color="#0000ff">void </font>*oView)</nobr></div>
<div style="position:absolute;top:31861;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:31874;left:193"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
<div style="position:absolute;top:31887;left:193"><nobr>Engine = (TrajBuffer*)oEngine;</nobr></div>
<div style="position:absolute;top:31900;left:193"><nobr>_setup = (setup*) oSetup;</nobr></div>
<div style="position:absolute;top:31912;left:193"><nobr>MachView = (CMach4View*)oView;</nobr></div>
<div style="position:absolute;top:31925;left:193"><nobr>MainPlanner = (TrajectoryControl *) oMainPlanner;</nobr></div>
<div style="position:absolute;top:31938;left:193"><nobr>TimerOn = <font color="#0000ff">false</font>;</nobr></div>
<div style="position:absolute;top:31951;left:193"><nobr>KickTimer = <font color="#0000ff">false</font>; <font color="#008000">//see update loop</font></nobr></div>
<div style="position:absolute;top:31964;left:193"><nobr>myInitControl ();</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:31976;left:193"><nobr>return true<font color="#000000">; </font><font color="#008000">//start the printer port.. Use this for all devices that need the</font></nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:31989;left:166"><nobr>printer port. For now..thats all of them..</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:32002;left:166"><nobr>}</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:32036;left:179"><nobr>Mach3 calls this routine during startup and uses it to setup the Block, App and</nobr></div>
<div style="position:absolute;top:32055;left:166"><nobr>planner variables for use in the plugin. KickTimer is used to startup a 40hz timer for</nobr></div>
<div style="position:absolute;top:32075;left:166"><nobr>fast processing work if it is required. Then the myInitControl is called. Heres a typical</nobr></div>
<div style="position:absolute;top:32094;left:166"><nobr>one for out ServoRun object.. </nobr></div>
</span></font>

<div style="position:absolute;top:32251;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="28"><b>Page 28</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:32305;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:32304;left:732"><nobr>27</nobr></div>
</span></font>
<font size="3" color="#0000ff" face="Times"><span style="font-size:12px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:32400;left:166"><nobr>void</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:32400;left:234"><nobr>myInitControl ()</nobr></div>
</span></font>
<font size="3" color="#008000" face="Times"><span style="font-size:12px;font-family:Times;color:#008000">
<div style="position:absolute;top:32416;left:166"><nobr>// called during Mach initialisation. You can influence subsequent</nobr></div>
<div style="position:absolute;top:32432;left:166"><nobr>init by actions here</nobr></div>
<div style="position:absolute;top:32448;left:166"><nobr>// **** Not used in typical device plugin</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:32464;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:32480;left:200"><nobr>MachView-&gt;m_PrinterOn = <font color="#0000ff">false</font>; <font color="#008000">//This signifies to MAch that this</font></nobr></div>
</span></font>
<font size="3" color="#008000" face="Times"><span style="font-size:12px;font-family:Times;color:#008000">
<div style="position:absolute;top:32496;left:166"><nobr>is an external Control device driver. </nobr></div>
<div style="position:absolute;top:32513;left:200"><nobr>//This doesn't mean this device will run, the user will decide</nobr></div>
<div style="position:absolute;top:32528;left:166"><nobr>what movement device to run in each profile. </nobr></div>
<div style="position:absolute;top:32545;left:200"><nobr>//use this only for a driver that actually controls pulsing..</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:32576;left:200"><nobr>RangeStart  = GetMenuRange( 2 ); <font color="#008000">// request 2 menu IDs to use</font></nobr></div>
</span></font>
<font size="3" color="#0000ff" face="Times"><span style="font-size:12px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:32608;left:200"><nobr>return<font color="#000000">;</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:32640;left:166"><nobr>} <font color="#008000">//myInitControl</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:32693;left:170"><nobr>Since this is an external motion plugin, the variable MachView-&gt;m_PrinterOn is set</nobr></div>
<div style="position:absolute;top:32712;left:166"><nobr>to false. This tells Mach3 that this plugin CAN be used to control motors, it will then</nobr></div>
<div style="position:absolute;top:32732;left:166"><nobr>appear in the device selection list. If it is actually selected for use, the PostInitControl</nobr></div>
<div style="position:absolute;top:32751;left:166"><nobr>function will be called. Otherwise postinit will not be called. SO this routine really</nobr></div>
<div style="position:absolute;top:32770;left:166"><nobr>only needs to notify Mach3 that the printer will not be used for output. The other call</nobr></div>
<div style="position:absolute;top:32790;left:166"><nobr>is to mach3 to reserve 2 menu items for this plugin. From that point forward, if the</nobr></div>
<div style="position:absolute;top:32809;left:166"><nobr>menu item is selected in Mach3, the myNotify will be called with the menu item ID as</nobr></div>
<div style="position:absolute;top:32829;left:166"><nobr>its message. This means the myNotify will have a message handler such as ..</nobr></div>
</span></font>
<font size="3" color="#0000ff" face="Times"><span style="font-size:12px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:32867;left:166"><nobr>if<font color="#000000">( message == (RangeStart + 1) )</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:32883;left:200"><nobr>{</nobr></div>
</span></font>
<font size="3" color="#0000ff" face="Times"><span style="font-size:12px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:32899;left:234"><nobr>if<font color="#000000">( sr != NULL )</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:32915;left:234"><nobr>{</nobr></div>
<div style="position:absolute;top:32931;left:276"><nobr>sr-&gt;DoFunctioForMenuItem#2</nobr></div>
<div style="position:absolute;top:32947;left:234"><nobr>}</nobr></div>
<div style="position:absolute;top:32963;left:200"><nobr>}</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:32999;left:174"><nobr>This presupposes that you have a menu handler in the plugin. Not all do, but you</nobr></div>
<div style="position:absolute;top:33019;left:166"><nobr>may add one. The example plugins show a menuhandler class that adds in menu items</nobr></div>
<div style="position:absolute;top:33038;left:166"><nobr>To Mach3's menu system. The class uses the RangeStart variable to determine the </nobr></div>
<div style="position:absolute;top:33058;left:166"><nobr>ID's that added menu components will have in the menu system. The code for menu</nobr></div>
<div style="position:absolute;top:33077;left:166"><nobr>Additions is fairly simple, and the MenuHandler Class files are pretty intuitive to use.</nobr></div>
<div style="position:absolute;top:33097;left:166"><nobr>You can see them in the ncPod example series. The MeneHandler is normally</nobr></div>
<div style="position:absolute;top:33116;left:166"><nobr>implemented in the myPostInit function. Since myPostInit doesn’t get called unless</nobr></div>
<div style="position:absolute;top:33136;left:166"><nobr>the user selects the device, the menu wont appear unless the device is actually in use.</nobr></div>
<div style="position:absolute;top:33155;left:166"><nobr>Heres a typical way of adding a menu without a menuhandler function just by adding</nobr></div>
<div style="position:absolute;top:33175;left:166"><nobr>the following in the myPostInit function.</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:33212;left:166"><nobr>static bool <font color="#000000">menued = </font>false<font color="#000000">;</font></nobr></div>
<div style="position:absolute;top:33225;left:193"><nobr>if<font color="#000000">( !menued)</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:33238;left:193"><nobr>{</nobr></div>
<div style="position:absolute;top:33251;left:220"><nobr>//" Startup of Menu handler"</nobr></div>
<div style="position:absolute;top:33263;left:220"><nobr>menued = <font color="#0000ff">true</font>;</nobr></div>
<div style="position:absolute;top:33276;left:220"><nobr>CFrameWnd *MachFrame = MachView-&gt;MachFrame;</nobr></div>
<div style="position:absolute;top:33289;left:220"><nobr>CMenu *menu = MachFrame-&gt;GetMenu();</nobr></div>
<div style="position:absolute;top:33302;left:220"><nobr>HMENU hSubmenu = CreatePopupMenu(); </nobr></div>
</span></font>

<div style="position:absolute;top:33439;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="29"><b>Page 29</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:33493;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:33492;left:732"><nobr>28</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:33568;left:220"><nobr>int <font color="#000000">pos = FindMenuItem(menu,"PlugIn Control");</font></nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:33581;left:220"><nobr>//here we can add menu items to MAch3's menu..</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:33594;left:220"><nobr>int <font color="#000000">x = pos;</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:33607;left:220"><nobr>HMENU control = GetSubMenu( menu-&gt;m_hMenu, pos);</nobr></div>
<div style="position:absolute;top:33619;left:220"><nobr>InsertMenu ( control, -1, MF_BYPOSITION, RangeStart , _T(MyDeviceName + " " +    </nobr></div>
<div style="position:absolute;top:33632;left:166"><nobr>SSVerString + " Config") );</nobr></div>
<div style="position:absolute;top:33645;left:220"><nobr>InsertMenu ( control, -1, MF_BYPOSITION, RangeStart+1 , _T("ServoRun Data</nobr></div>
<div style="position:absolute;top:33658;left:166"><nobr>Monitoring") );</nobr></div>
<div style="position:absolute;top:33671;left:220"><nobr>MachFrame-&gt;DrawMenuBar();</nobr></div>
<div style="position:absolute;top:33696;left:193"><nobr>} </nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:33723;left:179"><nobr>Obviously if you do this you need to also handle the notification messages</nobr></div>
<div style="position:absolute;top:33743;left:166"><nobr>appropriately in the myNotify function. </nobr></div>
<div style="position:absolute;top:33782;left:170"><nobr>If the user selects config form the config/plugings dialog in Mach3, the following</nobr></div>
<div style="position:absolute;top:33801;left:166"><nobr>function is called. It is not always implemented as the menu system works better for</nobr></div>
<div style="position:absolute;top:33821;left:166"><nobr>most users. But should the user select config from that dialog, this routine is called..</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:33858;left:166"><nobr>extern <font color="#000000">"C" </font>__declspec<font color="#000000">(</font>dllexport<font color="#000000">) </font>void <font color="#000000">Config( )    </font></nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:33858;left:559"><nobr>// CString  GetProfName();  </nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:33871;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:33884;left:193"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
<div style="position:absolute;top:33897;left:193"><nobr>DevProf = <font color="#0000ff">new</font></nobr></div>
<div style="position:absolute;top:33897;left:295"><nobr>CXMLProfile(); <font color="#008000">//start up the Profile class for XML usage. Same as</font></nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:33909;left:166"><nobr>Mach3's. </nobr></div>
<div style="position:absolute;top:33935;left:193"><nobr>//XML reading and writing can occur here..</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:33961;left:193"><nobr>myConfig (DevProf);</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:33986;left:193"><nobr>delete <font color="#000000">DevProf;</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:33999;left:166"><nobr>}</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:34052;left:179"><nobr>In most modern plugins, the myConfig routine simply puts out a message saying</nobr></div>
<div style="position:absolute;top:34072;left:166"><nobr>"Please use menu system for configuring this device". </nobr></div>
<div style="position:absolute;top:34111;left:166"><nobr>Next we have a few functions called by Mach3 for special events. </nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:34148;left:166"><nobr>extern <font color="#000000">"C" </font>__declspec<font color="#000000">(</font>dllexport<font color="#000000">) </font>void <font color="#000000">Reset() </font><font color="#008000">////////////////////  Called when Reset</font></nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:34161;left:166"><nobr>is pressed. </nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:34174;left:166"><nobr>{</nobr></div>
<div style="position:absolute;top:34187;left:193"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
<div style="position:absolute;top:34200;left:193"><nobr>myReset();</nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:34212;left:193"><nobr>//Called when reset is pressed, at end of actual reset commend in Mach3. </nobr></div>
<div style="position:absolute;top:34225;left:193"><nobr>//Check the Engine.Estop variable to see if we have reset or not..</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:34238;left:166"><nobr>}</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:34268;left:170"><nobr>The above is called when the user hits the reset button. It allows the ServoRun device</nobr></div>
<div style="position:absolute;top:34288;left:166"><nobr>to  gracefully stop, or reset itself when required by a rest button press. The plugin in</nobr></div>
<div style="position:absolute;top:34307;left:166"><nobr>the myReset can check to see if the Engine-&gt;Estop is set or not to see what the end</nobr></div>
<div style="position:absolute;top:34327;left:166"><nobr>state of the reset buttons function was, to Estop or move out of Estop.</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:34364;left:166"><nobr>extern <font color="#000000">"C" </font>__declspec<font color="#000000">(</font>dllexport<font color="#000000">) </font>void <font color="#000000">JogOn( </font>short <font color="#000000">axis, </font>short <font color="#000000">dir, </font>double <font color="#000000">speed )</font></nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:34377;left:166"><nobr>////////////////////  Called when Reset is pressed. </nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:34390;left:166"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:34403;left:193"><nobr>//Called when Jog is commanded. 0 for speed is Jog% jog, otherwise it is a new</nobr></div>
<div style="position:absolute;top:34415;left:166"><nobr>jog%</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:34428;left:193"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
<div style="position:absolute;top:34441;left:193"><nobr>MyJogOn(   axis,   dir,   speed);</nobr></div>
<div style="position:absolute;top:34454;left:166"><nobr>} </nobr></div>
</span></font>

<div style="position:absolute;top:34627;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="30"><b>Page 30</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:34681;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:34680;left:732"><nobr>29</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:34756;left:166"><nobr>extern <font color="#000000">"C" </font>__declspec<font color="#000000">(</font>dllexport<font color="#000000">) </font>void <font color="#000000">JogOff( </font>short <font color="#000000">axis ) </font><font color="#008000">//////////////////// </font></nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:34769;left:166"><nobr>Called when Reset is pressed. </nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:34782;left:166"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:34795;left:193"><nobr>//Called when jog should stop on a particular axis</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:34807;left:193"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
<div style="position:absolute;top:34820;left:193"><nobr>MyJogOff(axis); </nobr></div>
<div style="position:absolute;top:34833;left:166"><nobr>}</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:34867;left:174"><nobr>The above routines are called when Jogging is commanded. Normally in JogOn, the</nobr></div>
<div style="position:absolute;top:34886;left:166"><nobr>speed variable is zero, and the speed is controlled by the MainPlanner-&gt;JogPercent</nobr></div>
<div style="position:absolute;top:34905;left:166"><nobr>variable to scale the rapid speed of the axis to the right jog speed, however, when</nobr></div>
<div style="position:absolute;top:34925;left:166"><nobr>things like a shuttle pro are used and the speed is variable, then the speed variable will</nobr></div>
<div style="position:absolute;top:34945;left:166"><nobr>not be zero and indicated the required speed. The logic required for the device to jog</nobr></div>
<div style="position:absolute;top:34964;left:166"><nobr>will vary form device to device, but the plugin should check to ensure that the ring</nobr></div>
<div style="position:absolute;top:34983;left:166"><nobr>buffer is empty and that jogging is allowed in the current mode. </nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:35021;left:166"><nobr>extern <font color="#000000">"C" </font>__declspec<font color="#000000">(</font>dllexport<font color="#000000">) </font>void <font color="#000000">Purge( </font>short <font color="#000000">flags ) </font><font color="#008000">//////////////////// </font></nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:35034;left:166"><nobr>Called when Reset is pressed. </nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:35047;left:166"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:35060;left:193"><nobr>//Called when jog should stop on a particular axis</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:35072;left:193"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
<div style="position:absolute;top:35085;left:193"><nobr>myPurge(flags); </nobr></div>
<div style="position:absolute;top:35098;left:166"><nobr>}</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:35136;left:166"><nobr>extern <font color="#000000">"C" </font>__declspec<font color="#000000">(</font>dllexport<font color="#000000">) </font>void <font color="#000000">Probe( ) </font><font color="#008000">////////////////////  Called when Reset</font></nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:35149;left:166"><nobr>is pressed. </nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:35162;left:166"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:35175;left:193"><nobr>//Called when jog should stop on a particular axis</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:35187;left:193"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
<div style="position:absolute;top:35200;left:193"><nobr>myProbe(); </nobr></div>
<div style="position:absolute;top:35213;left:166"><nobr>}</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:35239;left:166"><nobr>extern <font color="#000000">"C" </font>__declspec<font color="#000000">(</font>dllexport<font color="#000000">) </font>void <font color="#000000">Home( </font>short <font color="#000000">axis ) </font><font color="#008000">////////////////////  Called</font></nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:35252;left:166"><nobr>when Reset is pressed. </nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:35264;left:166"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:35277;left:193"><nobr>//Called when jog should stop on a particular axis</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:35290;left:193"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
<div style="position:absolute;top:35303;left:193"><nobr>myHome( axis ); </nobr></div>
<div style="position:absolute;top:35315;left:166"><nobr>}</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:35349;left:174"><nobr>The Purge routine is seldom used, if at all, but in a device like the G100 it is used to</nobr></div>
<div style="position:absolute;top:35369;left:166"><nobr>tell the device to kill any moves it currently is running. The Probe and Home</nobr></div>
<div style="position:absolute;top:35388;left:166"><nobr>commands are used to initiate those functions. Homing should be automatic to the</nobr></div>
<div style="position:absolute;top:35408;left:166"><nobr>plugin, Mach3 simply waits for it to be done. See the section on Sequencing for more</nobr></div>
<div style="position:absolute;top:35427;left:166"><nobr>details on homing and probing.</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:35465;left:166"><nobr>void <font color="#000000">CALLBACK MYProc(HWND hwnd,UINT uMsg,UINT_PTR idEvent,DWORD dwTime)</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:35477;left:166"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:35490;left:227"><nobr>static int <font color="#000000">ticks = 0;</font></nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:35503;left:227"><nobr>//If the update loop doesn't turn this back on in 20 ticks. ( 1/2 second)</nobr></div>
<div style="position:absolute;top:35516;left:166"><nobr>then kill the timer, user </nobr></div>
<div style="position:absolute;top:35529;left:227"><nobr>// has shut us down. </nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:35542;left:227"><nobr>ticks++;</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:35554;left:227"><nobr>if<font color="#000000">( ticks &gt; 20 &amp;&amp; !KickTimer )</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:35567;left:227"><nobr>{</nobr></div>
<div style="position:absolute;top:35580;left:288"><nobr>KillTimer( hwnd, idEvent );</nobr></div>
<div style="position:absolute;top:35593;left:288"><nobr>TimerOn = <font color="#0000ff">false</font>;</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:35606;left:288"><nobr>return<font color="#000000">;</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:35618;left:227"><nobr>}</nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:35631;left:227"><nobr>//Alternately , lets make sure the user has us selected, if so, keep the</nobr></div>
<div style="position:absolute;top:35644;left:166"><nobr>timer running</nobr></div>
<div style="position:absolute;top:35657;left:227"><nobr>// in an indefinite loop of 40hz. </nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:35670;left:227"><nobr>if<font color="#000000">( KickTimer ) </font></nobr></div>
</span></font>

<div style="position:absolute;top:35815;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="31"><b>Page 31</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:35869;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:35868;left:732"><nobr>30</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:35944;left:227"><nobr>{ </nobr></div>
<div style="position:absolute;top:35957;left:288"><nobr>KickTimer = <font color="#0000ff">false</font>;</nobr></div>
<div style="position:absolute;top:35970;left:288"><nobr>ticks = 0; <font color="#008000">//reset the test</font></nobr></div>
<div style="position:absolute;top:35983;left:288"><nobr>TimerOn = <font color="#0000ff">true</font>;</nobr></div>
<div style="position:absolute;top:35995;left:227"><nobr>}</nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:36008;left:227"><nobr>//We get here at 40hz only if the user has selected us as ON, and the Mach3</nobr></div>
<div style="position:absolute;top:36021;left:166"><nobr>programs update loops are running correctly</nobr></div>
<div style="position:absolute;top:36034;left:227"><nobr>//Any interruption of Mach3 will operate as a safety watchdog and we wont get</nobr></div>
<div style="position:absolute;top:36047;left:166"><nobr>here in that case.</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:36072;left:227"><nobr>if<font color="#000000">( sr != NULL) sr-&gt;myHighSpeedUpdate();</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:36085;left:166"><nobr>}</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:36119;left:174"><nobr>This procedure is a 40hz timer used by some devices as an asynchronous method of</nobr></div>
<div style="position:absolute;top:36138;left:166"><nobr>processing. The normal update is synchronized to Mach3's 1/10 second loop, this</nobr></div>
<div style="position:absolute;top:36158;left:166"><nobr>timer is used to have a 40hz callback which is not related to Mach3's execution timers. </nobr></div>
<div style="position:absolute;top:36177;left:166"><nobr>TO use it you need only turn it on in the next routine, which is the main update loop.</nobr></div>
<div style="position:absolute;top:36197;left:166"><nobr>If the hi speed timer senses that the updates from mach3 have stopped ( Mach3 has</nobr></div>
<div style="position:absolute;top:36216;left:166"><nobr>shut down) then the kicktimer variable will stop the hi speed timer on its own..</nobr></div>
<div style="position:absolute;top:36255;left:174"><nobr>In Mach3's 1/10 second loop, the system  will look at a list of all plugins current</nobr></div>
<div style="position:absolute;top:36275;left:166"><nobr>enabled, and will call the Update() function in the MachDevice.cpp file that belongs</nobr></div>
<div style="position:absolute;top:36294;left:166"><nobr>to the plugin. It is this Update( ) routine that tells the plugin to check</nobr></div>
<div style="position:absolute;top:36313;left:166"><nobr>Itself, update any system variables that are in use, and do whatever else it needs to do</nobr></div>
<div style="position:absolute;top:36333;left:166"><nobr>for housekeeping. Any plugin should keep its time short in this routine. Its accepted</nobr></div>
<div style="position:absolute;top:36352;left:166"><nobr>that certain plugins are more complex than others, and generally even hard working</nobr></div>
<div style="position:absolute;top:36372;left:166"><nobr>code can be run in this routine , but things like displaying a Dialog and holding the</nobr></div>
<div style="position:absolute;top:36391;left:166"><nobr>routine in a DoModal() call are illegal. The system will , while waiting for the</nobr></div>
<div style="position:absolute;top:36411;left:166"><nobr>DoModal continue to call Update() and weird things can happen. In general keep the</nobr></div>
<div style="position:absolute;top:36430;left:166"><nobr>calls to the Update routine as simple as possible, and with no hard coded holdups. </nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:36468;left:166"><nobr>extern <font color="#000000">"C" </font>__declspec<font color="#000000">(</font>dllexport<font color="#000000">) </font>void <font color="#000000">Update() </font><font color="#008000">////////////////////  UPDATE LOOP 10</font></nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:36481;left:166"><nobr>Times a Second.</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:36494;left:166"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#008000" face="Times"><span style="font-size:9px;font-family:Times;color:#008000">
<div style="position:absolute;top:36506;left:193"><nobr>// This is your main update loop. Approx 10hz or so..</nobr></div>
<div style="position:absolute;top:36519;left:193"><nobr>// We'll get smoother control at a higher frequency, so start a timer that</nobr></div>
<div style="position:absolute;top:36532;left:193"><nobr>// runs at 40hz.  This Update loop will start the timer once and it will</nobr></div>
<div style="position:absolute;top:36545;left:193"><nobr>// run periodically from that point on.  If the timer routine sees that this</nobr></div>
<div style="position:absolute;top:36557;left:166"><nobr>routine</nobr></div>
<div style="position:absolute;top:36570;left:193"><nobr>// fails to run for a half second or so, it will shut down the timer.  If this</nobr></div>
<div style="position:absolute;top:36583;left:193"><nobr>// routine starts operating again, it can start the timer again if it sees it has</nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:36596;left:227"><nobr>AFX_MANAGE_STATE(AfxGetStaticModuleState( ));</nobr></div>
<div style="position:absolute;top:36609;left:227"><nobr>KickTimer = <font color="#0000ff">true</font>;</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:36622;left:227"><nobr>if<font color="#000000">( !TimerOn ) SetTimer(NULL, 1, 25, MYProc);</font></nobr></div>
<div style="position:absolute;top:36634;left:193"><nobr>if<font color="#000000">( sr != NULL) sr-&gt;myUpdate();</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:36660;left:166"><nobr>}   <font color="#008000">// Update</font></nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:36719;left:166"><nobr>TimerOn is a global Boolean used to tell the system the timer is running. Initially it is</nobr></div>
<div style="position:absolute;top:36739;left:166"><nobr>set to false and you'll find it at the top of the declarations in the machdevice.cpp file. </nobr></div>
<div style="position:absolute;top:36778;left:174"><nobr>That completes the set of functions that Mach3 uses to interface to a plugin. The</nobr></div>
<div style="position:absolute;top:36797;left:166"><nobr>only thing you need other than the above is your own sr object that implements the</nobr></div>
<div style="position:absolute;top:36817;left:166"><nobr>logic required to actually run the device. The plugin examples such as ncPod, and the</nobr></div>
<div style="position:absolute;top:36836;left:166"><nobr>G100 plugin show the devices using the above functions, and the logic of course will</nobr></div>
<div style="position:absolute;top:36855;left:166"><nobr>vary widely depending on the device used. Simple IO devices will have the easiest </nobr></div>
</span></font>

<div style="position:absolute;top:37003;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="32"><b>Page 32</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:37057;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:37056;left:732"><nobr>31</nobr></div>
<div style="position:absolute;top:37134;left:166"><nobr>time. They typically only look to an external device, joystick, HID , or transmission,</nobr></div>
<div style="position:absolute;top:37153;left:166"><nobr>get a status word and use that to set input signal in mach3 or to take mach3's output</nobr></div>
<div style="position:absolute;top:37173;left:166"><nobr>signals and send them to a device. Heres an example of getting a IO status word from</nobr></div>
<div style="position:absolute;top:37192;left:166"><nobr>your device  and sending them to the Mach3 signals . Its usually done in the</nobr></div>
<div style="position:absolute;top:37211;left:166"><nobr>myUpdate routine for your device.</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:37262;left:166"><nobr>int inword = sr-&gt;GetInputWord();</nobr></div>
<div style="position:absolute;top:37275;left:166"><nobr>for <font color="#000000">(</font>int <font color="#000000">x = 0; x &lt; nSigs; x++)</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:37288;left:166"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:37301;left:186"><nobr>if <font color="#000000">(Engine-&gt;InSigs[x].Active &amp;&amp; Engine-&gt;InSigs[x].InPort == 3 )</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:37313;left:186"><nobr>{</nobr></div>
</span></font>
<font size="2" color="#0000ff" face="Times"><span style="font-size:9px;font-family:Times;color:#0000ff">
<div style="position:absolute;top:37326;left:200"><nobr>int <font color="#000000">pin_state = (inword &gt;&gt; 1) &amp;&amp; 0x01;</font></nobr></div>
<div style="position:absolute;top:37339;left:200"><nobr>if <font color="#000000">(pin_state == 1)</font></nobr></div>
</span></font>
<font size="2" face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:37352;left:261"><nobr>Engine-&gt;InSigs[x].Activated = <font color="#0000ff">Engine-&gt;InSigs[x].Negated;</font></nobr></div>
<div style="position:absolute;top:37364;left:254"><nobr>else</nobr></div>
<div style="position:absolute;top:37377;left:261"><nobr>Engine-&gt;InSigs[x].Activated = ! <font color="#0000ff">Engine-&gt;InSigs[x].Negated</font>;</nobr></div>
<div style="position:absolute;top:37390;left:186"><nobr>}</nobr></div>
<div style="position:absolute;top:37403;left:166"><nobr>}</nobr></div>
</span></font>
<font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:37430;left:173"><nobr>As you can see the inword retrieved form the device is simply checked to see if it is </nobr></div>
<div style="position:absolute;top:37449;left:166"><nobr>Set, and if so, the input pin is set to the input signals level. Of course various logic can</nobr></div>
<div style="position:absolute;top:37469;left:166"><nobr>be applied here. Similar logic is used to create an output word for a plugin to send</nobr></div>
<div style="position:absolute;top:37488;left:166"><nobr>using the Engine-&gt;OutSigs[n] variable list . If an output signal is "activated" for</nobr></div>
<div style="position:absolute;top:37508;left:166"><nobr>example, typically a word bit is set to a one and then sent to the device.  </nobr></div>
<div style="position:absolute;top:37553;left:174"><nobr>By examining the headers in the MachIncludes folder, you'll find most structures</nobr></div>
<div style="position:absolute;top:37573;left:166"><nobr>you need to use in a plugin. The Engine-&gt; variables are found in the engine.h file, the</nobr></div>
<div style="position:absolute;top:37592;left:166"><nobr>MainPlanner-&gt; variables are found in the TrajectoryControl.h file, and are the typical</nobr></div>
<div style="position:absolute;top:37612;left:166"><nobr>variables one needs to use for most operations you'd like to attempt. </nobr></div>
<div style="position:absolute;top:37650;left:174"><nobr>As time permits Ill try to add more to this document in terms of what variable does</nobr></div>
<div style="position:absolute;top:37670;left:166"><nobr>what and what you can use to bypass certain logic in Mach3, but hopefully all this</nobr></div>
<div style="position:absolute;top:37690;left:166"><nobr>rambling has given you a start to understanding how a plugin does its job, and how</nobr></div>
<div style="position:absolute;top:37709;left:166"><nobr>Mach3 provides an interface to allow for plugins to use Mach3s data in various ways. </nobr></div>
<div style="position:absolute;top:37728;left:166"><nobr>Reading the plugin examples is the best way to see how I , or others, have decided to</nobr></div>
<div style="position:absolute;top:37748;left:166"><nobr>massage the system into doing as we wish in the plugin environment. </nobr></div>
<div style="position:absolute;top:37787;left:166"><nobr>Well, that’s it for now, I'm talked out. Have fun, remember that in the world of</nobr></div>
<div style="position:absolute;top:37806;left:166"><nobr>plugins, anything goes, you'll easily lock up mach3 if the logic of a plugin defies what</nobr></div>
<div style="position:absolute;top:37826;left:166"><nobr>Mach3 expects. There's allot more to say, and over time I'm sure it will be said, but I</nobr></div>
<div style="position:absolute;top:37845;left:166"><nobr>hope this document helps to explain some of the limitations and mysteries</nobr></div>
<div style="position:absolute;top:37865;left:166"><nobr>surrounding Mach3's internals. </nobr></div>
<div style="position:absolute;top:37904;left:166"><nobr>Art Fenerty</nobr></div>
<div style="position:absolute;top:37923;left:166"><nobr>January 28<font style="font-size:9px">th</font>, 2008 </nobr></div>
</span></font>

<div style="position:absolute;top:38191;left:0"><hr><table border="0" width="100%"><tbody><tr><td bgcolor="eeeeee" align="right"><font face="arial,sans-serif"><a name="33"><b>Page 33</b></a></font></td></tr></tbody></table></div><font size="3" face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:38245;left:166"><nobr>Fenerty/GCODE MACH3 AND OTHER MYSTERIES.</nobr></div>
<div style="position:absolute;top:38244;left:732"><nobr>32 </nobr></div>
</span></font>


</div></body></html>
